<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoldGPT Pro - Advanced AI Trading Platform</title>
    <!-- External Resources -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ai-analysis-center.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1a1a1a;
            --bg-quaternary: #222222;
            --border-primary: #2a2a2a;
            --border-secondary: #333333;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #666666;
            --accent-primary: #00d4aa;
            --accent-secondary: #4285f4;
            --success: #00d084;
            --danger: #ff4757;
            --warning: #ffa502;
            --gold: #ffd700;
            --purple: #8b5cf6;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.2);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: var(--gold);
        }

        .logo i {
            font-size: 24px;
        }

        .header-nav {
            display: flex;
            gap: 8px;
        }

        .header-nav-item {
            padding: 8px 16px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .header-nav-item:hover {
            background: var(--bg-quaternary);
            color: var(--text-primary);
        }

        .header-nav-item.active {
            background: var(--accent-primary);
            color: white;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .account-balance {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-primary);
        }

        .balance-value {
            font-weight: 600;
            color: var(--success);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Notification animations */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Chart control enhancements */
        .timeframe-btn, .indicator-btn {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .timeframe-btn:before, .indicator-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .timeframe-btn:hover:before, .indicator-btn:hover:before {
            left: 100%;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 64px 1fr;
            grid-template-areas: 
                "header header header"
                "sidebar content rightpanel";
            height: 100vh;
        }

        .sidebar {
            grid-area: sidebar;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            overflow-y: auto;
            scrollbar-width: thin;
        }

        .content {
            grid-area: content;
            overflow-y: auto;
            padding: 24px;
            background: var(--bg-primary);
        }

        .right-panel {
            grid-area: rightpanel;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-primary);
            overflow-y: auto;
            padding: 16px;
        }

        /* Sidebar Navigation */
        .nav-section {
            padding: 16px 0;
            border-bottom: 1px solid var(--border-primary);
        }

        .nav-section:last-child {
            border-bottom: none;
        }

        .nav-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 16px 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .nav-item:hover {
            background: var(--bg-quaternary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(0, 212, 170, 0.1);
            color: var(--accent-primary);
            border-right: 3px solid var(--accent-primary);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Watchlist */
        .watchlist {
            padding: 16px 0;
        }

        .watchlist-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            cursor: pointer;
            transition: var(--transition);
        }

        .watchlist-item:hover {
            background: var(--bg-quaternary);
        }

        .watchlist-item.active {
            background: rgba(0, 212, 170, 0.1);
            border-right: 3px solid var(--accent-primary);
        }

        .symbol-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .symbol-name {
            font-weight: 600;
            font-size: 14px;
        }

        .symbol-description {
            font-size: 12px;
            color: var(--text-muted);
        }

        .symbol-price {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .price-value {
            font-weight: 600;
            font-size: 14px;
        }

        .price-change {
            font-size: 12px;
            font-weight: 500;
        }

        .price-change.positive {
            color: var(--success);
        }

        .price-change.negative {
            color: var(--danger);
        }

        /* Chart Section */
        .chart-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-primary);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-tertiary);
        }

        .chart-symbol {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .symbol-badge {
            background: var(--gold);
            color: var(--bg-primary);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
        }

        .symbol-details h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .symbol-details .price {
            font-size: 24px;
            font-weight: 700;
            margin-top: 4px;
        }

        .chart-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .timeframe-selector {
            display: flex;
            background: var(--bg-quaternary);
            border-radius: 8px;
            padding: 4px;
        }

        .timeframe-btn {
            padding: 6px 12px;
            border: none;
            background: none;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: var(--transition);
        }

        .timeframe-btn.active,
        .timeframe-btn:hover {
            background: var(--accent-primary);
            color: white;
        }

        .chart-indicators {
            display: flex;
            gap: 8px;
        }

        .indicator-btn {
            padding: 6px 10px;
            border: 1px solid var(--border-secondary);
            background: none;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: var(--transition);
        }

        .indicator-btn.active {
            background: var(--accent-secondary);
            color: white;
            border-color: var(--accent-secondary);
        }

        .chart-content {
            height: 500px;
            position: relative;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .dashboard-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-primary);
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
        }

        .card-title i {
            color: var(--accent-primary);
        }

        .card-content {
            padding: 20px;
        }

        /* Trading Panel */
        .trading-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .order-type-selector {
            display: flex;
            background: var(--bg-quaternary);
            border-radius: 8px;
            padding: 4px;
        }

        .order-type-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: none;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }

        .order-type-btn.active {
            background: var(--accent-primary);
            color: white;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .input-field {
            padding: 12px 16px;
            background: var(--bg-quaternary);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: var(--transition);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }

        .trade-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        .trade-btn {
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .buy-btn {
            background: var(--success);
            color: white;
        }

        .buy-btn:hover {
            background: #00c078;
            transform: translateY(-1px);
        }

        .sell-btn {
            background: var(--danger);
            color: white;
        }

        .sell-btn:hover {
            background: #ff3742;
            transform: translateY(-1px);
        }

        .trade-btn-price {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
        }

        /* AI Analysis Panel */
        .ai-analysis {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .confidence-meter {
            background: var(--bg-quaternary);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .confidence-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }

        .confidence-label {
            font-size: 14px;
            color: var(--text-muted);
        }

        .analysis-indicators {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .indicator-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-primary);
        }

        .indicator-row:last-child {
            border-bottom: none;
        }

        .indicator-name {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .indicator-value {
            font-weight: 600;
        }

        .signal-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .signal-badge.buy {
            background: rgba(0, 208, 132, 0.2);
            color: var(--success);
        }

        .signal-badge.sell {
            background: rgba(255, 71, 87, 0.2);
            color: var(--danger);
        }

        .signal-badge.hold {
            background: rgba(255, 165, 2, 0.2);
            color: var(--warning);
        }

        /* Right Panel */
        .panel-section {
            margin-bottom: 24px;
        }

        .panel-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-section-title i {
            color: var(--accent-primary);
        }

        /* Order Book */
        .order-book {
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .order-book-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-primary);
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .order-book-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            padding: 4px 0;
            font-size: 12px;
            transition: var(--transition);
        }

        .order-book-row:hover {
            background: var(--bg-quaternary);
        }

        .ask-price {
            color: var(--danger);
        }

        .bid-price {
            color: var(--success);
        }

        /* Market News */
        .news-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .news-item:hover {
            background: var(--bg-quaternary);
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .news-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .news-impact {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .news-impact.high {
            background: var(--danger);
            color: white;
        }

        .news-impact.medium {
            background: var(--warning);
            color: white;
        }

        .news-impact.low {
            background: var(--text-muted);
            color: white;
        }

        /* Positions */
        .positions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .position-item {
            background: var(--bg-quaternary);
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid var(--accent-primary);
        }

        .position-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .position-symbol {
            font-weight: 600;
            font-size: 14px;
        }

        .position-side {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .position-side.buy {
            background: var(--success);
            color: white;
        }

        .position-side.sell {
            background: var(--danger);
            color: white;
        }

        .position-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
        }

        .position-pnl {
            font-weight: 600;
        }

        .position-pnl.positive {
            color: var(--success);
        }

        .position-pnl.negative {
            color: var(--danger);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 260px 1fr;
                grid-template-areas: 
                    "header header"
                    "sidebar content";
            }
            
            .right-panel {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-areas: 
                    "header"
                    "content";
            }
            
            .sidebar {
                display: none;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-secondary);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Price flash animations */
        .price-flash {
            animation: priceFlash 0.5s ease-in-out;
        }
        
        .price-up {
            color: var(--success) !important;
        }
        
        .price-down {
            color: var(--error) !important;
        }
        
        @keyframes priceFlash {
            0% { background-color: transparent; }
            50% { background-color: rgba(255, 215, 0, 0.3); }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-crown"></i>
                    <span>GoldGPT Pro</span>
                </div>
                <nav class="header-nav">
                    <button class="header-nav-item active" data-section="trading">Trading</button>
                    <button class="header-nav-item" data-section="portfolio">Portfolio</button>
                    <button class="header-nav-item" data-section="analysis">Analysis</button>
                    <button class="header-nav-item" data-section="markets">Markets</button>
                </nav>
            </div>
            <div class="header-right">
                <div class="account-balance">
                    <i class="fas fa-wallet"></i>
                    <span class="balance-value" id="account-balance">$10,000.00</span>
                </div>
                <div class="connection-status">
                    <div class="status-dot"></div>
                    <span>Live</span>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Navigation -->
            <nav class="nav-section">
                <div class="nav-section-title">Trading</div>
                <button class="nav-item active" data-section="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </button>
                <button class="nav-item" data-section="positions">
                    <i class="fas fa-layer-group"></i>
                    <span>Positions</span>
                </button>
                <button class="nav-item" data-section="orders">
                    <i class="fas fa-list-ul"></i>
                    <span>Orders</span>
                </button>
                <button class="nav-item" data-section="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
            </nav>

            <!-- AI Tools -->
            <nav class="nav-section">
                <div class="nav-section-title">AI Tools</div>
                <button class="nav-item" data-section="ai-analysis">
                    <i class="fas fa-brain"></i>
                    <span>AI Analysis</span>
                </button>
                <button class="nav-item" data-section="signals">
                    <i class="fas fa-satellite-dish"></i>
                    <span>Signals</span>
                </button>
                <button class="nav-item" data-section="backtest">
                    <i class="fas fa-flask"></i>
                    <span>Backtest</span>
                </button>
            </nav>

            <!-- Watchlist -->
            <div class="nav-section">
                <div class="nav-section-title">Watchlist</div>
                <div class="watchlist">
                    <div class="watchlist-item active" data-symbol="XAUUSD">
                        <div class="symbol-info">
                            <div class="symbol-name">
                                XAU/USD
                                <span class="live-indicator">LIVE</span>
                            </div>
                            <div class="symbol-description">Gold Spot</div>
                        </div>
                        <div class="symbol-price">
                            <div class="price-value">$2,085.40</div>
                            <div class="price-change positive">+0.85%</div>
                        </div>
                    </div>
                    <div class="watchlist-item" data-symbol="XAGUSD">
                        <div class="symbol-info">
                            <div class="symbol-name">XAG/USD</div>
                            <div class="symbol-description">Silver Spot</div>
                        </div>
                        <div class="symbol-price">
                            <div class="price-value">$24.15</div>
                            <div class="price-change negative">-0.32%</div>
                        </div>
                    </div>
                    <div class="watchlist-item" data-symbol="EURUSD">
                        <div class="symbol-info">
                            <div class="symbol-name">EUR/USD</div>
                            <div class="symbol-description">Euro Dollar</div>
                        </div>
                        <div class="symbol-price">
                            <div class="price-value">1.0875</div>
                            <div class="price-change positive">+0.12%</div>
                        </div>
                    </div>
                    <div class="watchlist-item" data-symbol="BTCUSD">
                        <div class="symbol-info">
                            <div class="symbol-name">BTC/USD</div>
                            <div class="symbol-description">Bitcoin</div>
                        </div>
                        <div class="symbol-price">
                            <div class="price-value">$43,250</div>
                            <div class="price-change positive">+2.45%</div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <!-- Chart Section -->
            <div class="chart-container fade-in">
                <div class="chart-header">
                    <div class="chart-symbol">
                        <div class="symbol-badge live" id="symbol-badge">GOLD</div>
                        <div class="symbol-details">
                            <h3>XAU/USD - Gold Spot</h3>
                            <div class="price" id="current-price">$2,085.40</div>
                            <div class="change" id="price-change">
                                <span class="positive">+$12.45 (+0.60%)</span>
                            </div>
                            <div class="price-source live-indicator" id="price-source" style="font-size: 12px; margin-top: 6px;">
                                <i class="fas fa-satellite-dish"></i> Live from Gold-API.com
                            </div>
                        </div>
                    </div>
                    <div class="chart-controls">
                        <div class="timeframe-selector">
                            <button class="timeframe-btn" data-timeframe="1m">1M</button>
                            <button class="timeframe-btn" data-timeframe="5m">5M</button>
                            <button class="timeframe-btn" data-timeframe="15m">15M</button>
                            <button class="timeframe-btn active" data-timeframe="1h">1H</button>
                            <button class="timeframe-btn" data-timeframe="4h">4H</button>
                            <button class="timeframe-btn" data-timeframe="1d">1D</button>
                        </div>
                        <div class="chart-indicators">
                            <button class="indicator-btn" data-indicator="volume">Volume</button>
                            <button class="indicator-btn active" data-indicator="rsi">RSI</button>
                            <button class="indicator-btn" data-indicator="macd">MACD</button>
                            <button class="indicator-btn" data-indicator="bb">Bollinger</button>
                        </div>
                    </div>
                </div>
                <div class="chart-content" id="tradingview-chart">
                    <!-- TradingView Chart Widget will be loaded here -->
                </div>
                
                <!-- Immediate Chart Script -->
                <script>
                    // IMMEDIATE CHART LOADING - WORKING SOLUTION
                    function loadTradingViewChart() {
                        console.log('🚀 Loading TradingView chart immediately...');
                        
                        if (typeof TradingView === 'undefined') {
                            console.log('⏳ TradingView not ready, retrying in 100ms...');
                            setTimeout(loadTradingViewChart, 100);
                            return;
                        }
                        
                        try {
                            console.log('✅ Creating TradingView widget...');
                            
                            window.mainTVWidget = new TradingView.widget({
                                "width": "100%",
                                "height": "500",
                                "symbol": "OANDA:XAUUSD",
                                "interval": "60",
                                "timezone": "Etc/UTC",
                                "theme": "dark",
                                "style": "1",
                                "locale": "en",
                                "toolbar_bg": "#1a1a1a",
                                "enable_publishing": false,
                                "hide_top_toolbar": false,
                                "hide_legend": false,
                                "save_image": false,
                                "container_id": "tradingview-chart",
                                "studies": [
                                    "Volume@tv-basicstudies",
                                    "RSI@tv-basicstudies",
                                    "MACD@tv-basicstudies",
                                    "BB@tv-basicstudies"
                                ],
                                "allow_symbol_change": true,
                                "details": true,
                                "hotlist": true,
                                "calendar": true,
                                "studies_overrides": {
                                    "volume.volume.color.1": "#00d084",
                                    "volume.volume.color.0": "#ff6b6b"
                                },
                                "overrides": {
                                    "symbolWatermarkProperties.transparency": 90,
                                    "scalesProperties.textColor": "#ffffff",
                                    "paneProperties.background": "#1a1a1a",
                                    "paneProperties.vertGridProperties.color": "#2a2a2a",
                                    "paneProperties.horzGridProperties.color": "#2a2a2a"
                                }
                            });
                            
                            window.mainTVWidget.onChartReady(() => {
                                console.log('🎉 Main dashboard chart ready!');
                            });
                            
                            console.log('✅ Main TradingView widget created');
                            
                        } catch (error) {
                            console.error('❌ Chart error:', error);
                        }
                    }
                    
                    // Start loading immediately
                    loadTradingViewChart();
                    
                    // Also try when DOM is ready
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', loadTradingViewChart);
                    }
                </script>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Trading Panel -->
                <div class="dashboard-card slide-up">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-rocket"></i>
                            Quick Trade
                        </div>
                        <div class="connection-status">
                            <div class="status-dot"></div>
                            <span>Live Trading</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="trading-panel">
                            <div class="order-type-selector">
                                <button class="order-type-btn active" data-type="market">Market</button>
                                <button class="order-type-btn" data-type="limit">Limit</button>
                                <button class="order-type-btn" data-type="stop">Stop</button>
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">Amount (lots)</label>
                                <input type="number" class="input-field" id="trade-amount" value="0.1" step="0.01" min="0.01">
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">Stop Loss</label>
                                <input type="number" class="input-field" id="stop-loss" placeholder="Optional">
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">Take Profit</label>
                                <input type="number" class="input-field" id="take-profit" placeholder="Optional">
                            </div>
                            
                            <div class="trade-buttons">
                                <button class="trade-btn buy-btn" id="buy-btn">
                                    <span>BUY</span>
                                    <span class="trade-btn-price" id="buy-price">$2,085.40</span>
                                </button>
                                <button class="trade-btn sell-btn" id="sell-btn">
                                    <span>SELL</span>
                                    <span class="trade-btn-price" id="sell-price">$2,085.38</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis Center (Dynamic, Real-Time) -->
                <div class="dashboard-card slide-up ai-analysis-center" id="ai-analysis-center">
                    <div class="analysis-header">
                        <div class="analysis-title">
                            <i class="fas fa-brain"></i>
                            <h2>AI Analysis Center</h2>
                            <div class="analysis-status">
                                <div class="status-dot loading" id="analysis-status"></div>
                                <span id="analysis-status-text">Initializing...</span>
                            </div>
                        </div>
                        <div class="analysis-controls">
                            <div class="symbol-selector">
                                <select id="analysis-symbol">
                                    <option value="XAUUSD">XAUUSD (Gold)</option>
                                    <option value="EURUSD">EURUSD</option>
                                    <option value="GBPUSD">GBPUSD</option>
                                    <option value="USDJPY">USDJPY</option>
                                    <option value="SPY">SPY (S&P 500)</option>
                                    <option value="QQQ">QQQ (NASDAQ)</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="refresh-analysis">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                            <button class="btn btn-secondary" id="auto-refresh-toggle">
                                <i class="fas fa-clock"></i>
                                Auto: OFF
                            </button>
                        </div>
                    </div>
                    <!-- Overall Recommendation -->
                    <div class="overall-recommendation" id="overall-recommendation">
                        <div class="recommendation-card">
                            <div class="recommendation-header">
                                <h3>Overall Market Recommendation</h3>
                                <div class="confidence-score" id="confidence-score">--</div>
                            </div>
                            <div class="recommendation-content">
                                <div class="recommendation-signal">
                                    <div class="signal-badge hold" id="signal-badge">ANALYZING</div>
                                    <div class="signal-strength" id="signal-strength">Please wait...</div>
                                </div>
                                <div class="recommendation-reasoning">
                                    <ul id="reasoning-list">
                                        <li>Initializing AI analysis systems...</li>
                                        <li>Loading market data...</li>
                                        <li>Processing technical indicators...</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Analysis Panels Grid -->
                    <div class="analysis-grid">
                        <!-- Technical Analysis Panel -->
                        <div class="analysis-panel" id="technical-analysis-panel">
                            <div class="panel-header">
                                <h3><i class="fas fa-chart-line"></i> Technical Analysis</h3>
                                <div class="panel-status">
                                    <div class="status-dot loading"></div>
                                    <span>Loading...</span>
                                </div>
                            </div>
                            <div class="panel-content">
                                <div class="indicators-grid" id="technical-indicators">
                                    <!-- Technical indicators will be loaded here -->
                                </div>
                            </div>
                        </div>
                        <!-- Sentiment Analysis Panel -->
                        <div class="analysis-panel" id="sentiment-analysis-panel">
                            <div class="panel-header">
                                <h3><i class="fas fa-heart-pulse"></i> Market Sentiment</h3>
                                <div class="panel-status">
                                    <div class="status-dot loading"></div>
                                    <span>Loading...</span>
                                </div>
                            </div>
                            <div class="panel-content">
                                <div class="sentiment-overview" id="sentiment-overview">
                                    <!-- Sentiment analysis will be loaded here -->
                                </div>
                            </div>
                        </div>
                        <!-- ML Predictions Panel -->
                        <div class="analysis-panel" id="ml-predictions-panel">
                            <div class="panel-header">
                                <h3><i class="fas fa-robot"></i> ML Predictions</h3>
                                <div class="panel-status">
                                    <div class="status-dot loading"></div>
                                    <span>Loading...</span>
                                </div>
                            </div>
                            <div class="panel-content">
                                <div class="predictions-grid" id="ml-predictions">
                                    <!-- ML predictions will be loaded here -->
                                </div>
                            </div>
                        </div>
                        <!-- Market News Panel -->
                        <div class="analysis-panel" id="market-news-panel">
                            <div class="panel-header">
                                <h3><i class="fas fa-newspaper"></i> Market News</h3>
                                <div class="panel-status">
                                    <div class="status-dot loading"></div>
                                    <span>Loading...</span>
                                </div>
                            </div>
                            <div class="panel-content">
                                <div class="news-list" id="market-news">
                                    <!-- Market news will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Panel -->
        <aside class="right-panel">
            <!-- Order Book -->
            <div class="panel-section">
                <div class="panel-section-title">
                    <i class="fas fa-layer-group"></i>
                    Order Book
                </div>
                <div class="order-book">
                    <div class="order-book-header">
                        <span>Price</span>
                        <span>Size</span>
                        <span>Total</span>
                    </div>
                    <div id="order-book-content">
                        <!-- Order book data will be populated here -->
                        <div class="order-book-row">
                            <span class="ask-price">2,085.45</span>
                            <span>1.25</span>
                            <span>2,606.81</span>
                        </div>
                        <div class="order-book-row">
                            <span class="ask-price">2,085.42</span>
                            <span>0.75</span>
                            <span>1,564.07</span>
                        </div>
                        <div class="order-book-row">
                            <span class="ask-price">2,085.40</span>
                            <span>2.10</span>
                            <span>4,379.34</span>
                        </div>
                        <div class="order-book-row">
                            <span class="bid-price">2,085.38</span>
                            <span>1.85</span>
                            <span>3,857.95</span>
                        </div>
                        <div class="order-book-row">
                            <span class="bid-price">2,085.35</span>
                            <span>0.95</span>
                            <span>1,981.08</span>
                        </div>
                        <div class="order-book-row">
                            <span class="bid-price">2,085.32</span>
                            <span>1.40</span>
                            <span>2,919.45</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Macro Economic Indicators -->
            <div class="panel-section">
                <div class="panel-section-title">
                    <i class="fas fa-globe-americas"></i>
                    Macro Indicators
                </div>
                <div id="macro-indicators">
                    <div class="macro-grid">
                        <div class="macro-item">
                            <span class="macro-label">USD Index</span>
                            <span class="macro-value">103.25</span>
                            <span class="macro-change positive">+0.15</span>
                        </div>
                        <div class="macro-item">
                            <span class="macro-label">10Y Treasury</span>
                            <span class="macro-value">4.25%</span>
                        </div>
                        <div class="macro-item">
                            <span class="macro-label">VIX</span>
                            <span class="macro-value">18.5</span>
                        </div>
                        <div class="macro-item">
                            <span class="macro-label">CPI Annual</span>
                            <span class="macro-value">3.2%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market News -->
            <div class="panel-section">
                <div class="panel-section-title">
                    <i class="fas fa-newspaper"></i>
                    Market News
                    <div class="news-refresh-btn" onclick="refreshNewsData()" title="Refresh News">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                </div>
                <div id="market-news" class="news-list">
                    <!-- News will be populated by JavaScript -->
                    <div class="news-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Loading market news...</span>
                    </div>
                </div>
            </div>

            <!-- Open Positions -->
            <div class="panel-section">
                <div class="panel-section-title">
                    <i class="fas fa-chart-bar"></i>
                    Open Positions
                </div>
                <div class="positions-list" id="positions-list">
                    <!-- Positions will be populated here -->
                    <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                        No open positions
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Gold API Status Indicator -->
    <div class="gold-api-status" id="gold-api-status">
        <i class="fas fa-satellite-dish"></i>
        <span id="gold-api-text">Connecting to Gold API...</span>
    </div>

    <!-- Socket.IO for real-time updates -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <!-- Advanced Financial Libraries -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js" 
            onerror="console.error('Primary LightweightCharts failed, trying backup...'); loadBackupCharts();"></script>
    <script>
        // Backup chart library loader
        function loadBackupCharts() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js';
            script.onload = () => console.log('✅ Backup LightweightCharts loaded!');
            script.onerror = () => console.error('❌ All LightweightCharts sources failed');
            document.head.appendChild(script);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    
    <style>
        /* Notification styles */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            min-width: 300px;
            box-shadow: var(--shadow-lg);
            transform: translateX(100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-success {
            background: linear-gradient(135deg, #00d084, #00a86b);
            border-left: 4px solid #00c078;
        }

        .notification-error {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            border-left: 4px solid #ff2d41;
        }

        .notification-info {
            background: linear-gradient(135deg, #4285f4, #1a73e8);
            border-left: 4px solid #1669f2;
        }

        .notification-warning {
            background: linear-gradient(135deg, #ffa502, #ff9500);
            border-left: 4px solid #ff8c00;
        }

        /* Button hover effects */
        .trade-btn {
            position: relative;
            overflow: hidden;
        }

        .trade-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .trade-btn:hover::before {
            left: 100%;
        }

        /* Chart loading animation */
        .chart-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
        }

        .chart-loading::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-secondary);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        /* Price flash animation */
        @keyframes priceFlash {
            0% { 
                background-color: var(--gold); 
                color: var(--bg-primary); 
                transform: scale(1.05);
            }
            100% { 
                background-color: transparent; 
                color: inherit;
                transform: scale(1);
            }
        }

        .price-flash {
            animation: priceFlash 0.5s ease-out;
        }

        .price-up {
            color: var(--success) !important;
        }

        .price-down {
            color: var(--danger) !important;
        }

        /* Advanced Chart Styling */
        #goldChart {
            border-radius: 8px;
            background: var(--bg-secondary);
        }

        .chart-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-primary);
            overflow: hidden;
        }

        .chart-content {
            background: var(--bg-primary);
            min-height: 500px;
            position: relative;
        }

        /* Chart loading improvements */
        .chart-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            gap: 16px;
        }

        .chart-loading i {
            font-size: 48px;
            color: var(--accent-primary);
            animation: pulse 2s infinite;
        }

        .chart-loading p {
            font-size: 16px;
            margin: 0;
        }

        /* Macro Indicators Styling */
        .macro-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 8px 0;
        }

        .macro-item {
            background: var(--bg-quaternary);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: var(--transition);
        }

        .macro-item:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
        }

        .macro-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .macro-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .macro-change {
            font-size: 12px;
            font-weight: 600;
        }

        .macro-change.positive {
            color: var(--success);
        }

        .macro-change.negative {
            color: var(--danger);
        }

        /* Enhanced News Styling */
        .news-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .news-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-primary);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .news-item:hover {
            background: var(--bg-quaternary);
            transform: translateX(4px);
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .news-impact {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .news-impact.high {
            background: var(--danger);
            color: white;
        }

        .news-impact.medium {
            background: var(--warning);
            color: white;
        }

        .news-impact.low {
            background: var(--text-muted);
            color: white;
        }

        .news-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .news-sentiment {
            font-size: 12px;
            margin-left: auto;
        }

        .news-sentiment.positive {
            color: var(--success);
        }

        .news-sentiment.negative {
            color: var(--danger);
        }

        .news-sentiment.neutral {
            color: var(--text-muted);
        }

        .news-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .news-source {
            font-size: 11px;
            color: var(--text-muted);
            font-style: italic;
        }

        .news-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 20px;
            color: var(--text-muted);
        }

        .news-refresh-btn {
            margin-left: auto;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .news-refresh-btn:hover {
            background: var(--bg-quaternary);
            color: var(--accent-primary);
        }

        /* LightweightCharts Container */
        .tradingview-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: var(--bg-primary);
            border-radius: 8px;
            overflow: hidden;
        }

        /* Data Source Indicators */
        .data-source-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid var(--accent-primary);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 10;
        }

        .data-source-indicator.live {
            animation: pulse 2s infinite;
        }

        .data-source-indicator.fallback {
            background: rgba(255, 165, 2, 0.1);
            border-color: var(--warning);
            color: var(--warning);
        }

        .data-source-indicator.error {
            background: rgba(255, 71, 87, 0.1);
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Enhanced Scrollbars */
        .news-list::-webkit-scrollbar,
        .macro-grid::-webkit-scrollbar {
            width: 6px;
        }

        .news-list::-webkit-scrollbar-track,
        .macro-grid::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }

        .news-list::-webkit-scrollbar-thumb,
        .macro-grid::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 3px;
        }

        .news-list::-webkit-scrollbar-thumb:hover,
        .macro-grid::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Improved scrollbars for Webkit browsers */
        .sidebar::-webkit-scrollbar,
        .right-panel::-webkit-scrollbar,
        .content::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track,
        .right-panel::-webkit-scrollbar-track,
        .content::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .sidebar::-webkit-scrollbar-thumb,
        .right-panel::-webkit-scrollbar-thumb,
        .content::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover,
        .right-panel::-webkit-scrollbar-thumb:hover,
        .content::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Price source indicator */
        .price-source {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--success);
            margin-top: 4px;
            animation: pulse 2s infinite;
        }
        
        .price-source i {
            animation: spin 2s linear infinite;
        }
        
        /* Live price indicator */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(0, 208, 132, 0.1);
            color: var(--success);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .live-indicator::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        /* Gold API status indicator */
        .gold-api-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 12px;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
            min-width: 200px;
            display: block;
        }
        
        .gold-api-status.connected {
            border-color: var(--success);
            color: var(--success);
            background: rgba(0, 208, 132, 0.1);
            display: block;
        }
        
        .gold-api-status.fallback {
            border-color: var(--warning);
            color: var(--warning);
            background: rgba(255, 165, 2, 0.1);
            display: block;
        }
        
        .gold-api-status.error {
            border-color: var(--danger);
            color: var(--danger);
            background: rgba(255, 71, 87, 0.1);
            display: block;
        }

        .gold-api-status i {
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @media (prefers-reduced-motion: reduce) {
            .notification {
                transition: none;
            }
            
            .trade-btn::before {
                display: none;
            }
            
            .price-flash {
                animation: none;
            }
        }
    </style>
</head>
<body>
    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // Global state with enhanced data management
        let currentSymbol = 'XAUUSD';
        let chartInstance = null;
        let lightweightChart = null;
        let orderBookData = {};
        let positions = [];
        let priceHistory = [];
        let macroData = {};
        let newsData = [];
        let realTimePriceInterval = null;
        let goldApiConnected = false;
        
        // Advanced Data Sources Configuration
        const dataSources = {
            goldApi: {
                url: 'https://api.gold-api.com/price/XAU',
                headers: { 'Accept': 'application/json' },
                active: true
            },
            newsApi: {
                endpoints: [
                    'https://newsapi.org/v2/everything?q=gold+trading&sortBy=publishedAt',
                    'https://api.marketstack.com/v1/news',
                    'https://finnhub.io/api/v1/news'
                ],
                active: true
            },
            macroApi: {
                endpoints: [
                    'https://api.stlouisfed.org/fred/series/observations',
                    'https://api.eia.gov/v2/petroleum/pri/spt/s1/daily/data.json',
                    'https://api.tradingeconomics.com/indicators'
                ],
                active: true
            }
        };

        // Enhanced Advanced Real-Time Gold Price Fetcher with Gold-API Integration
        class AdvancedGoldPriceFetcher {
            constructor() {
                this.apiKey = null; // Set your Gold-API key if needed
                this.baseUrl = 'https://api.gold-api.com/price/XAU';
                this.fallbackUrls = [
                    'https://api.metals.live/v1/spot/gold',
                    'https://api.coinbase.com/v2/exchange-rates?currency=USD'
                ];
                this.updateInterval = 2000; // 2 seconds for real-time
                this.isConnected = false;
                this.retryCount = 0;
                this.maxRetries = 3;
            }

            async fetchLiveGoldPrice() {
                try {
                    console.log('📡 Fetching live gold price from Gold-API.com...');
                    
                    // Gold-API.com endpoint - exactly as specified in reference
                    const response = await fetch(this.baseUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'GoldGPT-Pro/1.0',
                            'Cache-Control': 'no-cache',
                            ...(this.apiKey && { 'Authorization': `Bearer ${this.apiKey}` })
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Gold-API error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('✅ Gold-API.com response:', data);

                    // Process Gold-API.com response format
                    const processedData = this.processGoldApiResponse(data);
                    
                    this.isConnected = true;
                    this.retryCount = 0;
                    this.updateConnectionStatus(true, 'Gold-API.com');
                    
                    return processedData;

                } catch (error) {
                    console.error('❌ Gold-API.com error:', error);
                    
                    if (this.retryCount < this.maxRetries) {
                        this.retryCount++;
                        console.log(`🔄 Retrying Gold-API.com (${this.retryCount}/${this.maxRetries})...`);
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        return this.fetchLiveGoldPrice();
                    }
                    
                    console.log('🔄 Falling back to alternative sources...');
                    return this.fetchFromFallbackSources();
                }
            }

            processGoldApiResponse(data) {
                // Handle Gold-API.com response format - multiple possible formats
                let price, timestamp, currency = 'USD';
                
                // Format 1: Direct price field
                if (data.price && typeof data.price === 'number') {
                    price = parseFloat(data.price);
                }
                // Format 2: Price in USD field
                else if (data.price_usd) {
                    price = parseFloat(data.price_usd);
                }
                // Format 3: Rates object with USD
                else if (data.rates && data.rates.USD) {
                    price = parseFloat(data.rates.USD);
                }
                // Format 4: Ask/Bid average
                else if (data.ask && data.bid) {
                    price = (parseFloat(data.ask) + parseFloat(data.bid)) / 2;
                }
                // Format 5: Gold object with price
                else if (data.gold && data.gold.price) {
                    price = parseFloat(data.gold.price);
                }
                // Format 6: XAU object
                else if (data.XAU) {
                    price = parseFloat(data.XAU);
                }
                else {
                    console.warn('Unknown Gold-API response format:', data);
                    throw new Error('Unknown Gold-API response format');
                }

                // Handle timestamp
                if (data.timestamp) {
                    timestamp = new Date(data.timestamp * 1000);
                } else if (data.date) {
                    timestamp = new Date(data.date);
                } else if (data.updated) {
                    timestamp = new Date(data.updated);
                } else {
                    timestamp = new Date();
                }
                
                // Calculate change from previous price
                const previousPrice = priceHistory.length > 0 ? 
                    priceHistory[priceHistory.length - 1].close : price;
                const change = price - previousPrice;
                const changePercent = previousPrice > 0 ? ((change / previousPrice) * 100) : 0;

                const processedData = {
                    symbol: 'XAUUSD',
                    price: parseFloat(price.toFixed(2)),
                    change: parseFloat(change.toFixed(2)),
                    change_percent: parseFloat(changePercent.toFixed(3)),
                    timestamp: timestamp,
                    source: 'Gold-API',
                    bid: data.bid ? parseFloat(data.bid) : (price - 0.50),
                    ask: data.ask ? parseFloat(data.ask) : (price + 0.50),
                    volume: data.volume || Math.floor(Math.random() * 10000) + 5000,
                    high_24h: data.high_24h || (price * 1.015),
                    low_24h: data.low_24h || (price * 0.985),
                    currency: currency
                };

                console.log('✅ Processed Gold price data:', processedData);
                return processedData;
            }

            async fetchFromFallbackSources() {
                for (const fallbackUrl of this.fallbackUrls) {
                    try {
                        console.log(`🔄 Trying fallback source: ${fallbackUrl}`);
                        
                        const response = await fetch(fallbackUrl, {
                            method: 'GET',
                            headers: { 'Accept': 'application/json' }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            const processedData = this.processFallbackResponse(data, fallbackUrl);
                            
                            this.updateConnectionStatus(false, 'Fallback API');
                            return processedData;
                        }
                    } catch (error) {
                        console.warn(`❌ Fallback source failed: ${fallbackUrl}`, error);
                    }
                }

                // Ultimate fallback: generate realistic simulated data
                console.log('⚠️ All APIs failed, using simulated data...');
                return this.generateSimulatedPrice();
            }

            processFallbackResponse(data, source) {
                // Process different fallback API formats
                let price = 2000; // Default gold price base

                if (data.rates && data.rates.XAU) {
                    price = 1 / parseFloat(data.rates.XAU);
                } else if (data.spot_price) {
                    price = parseFloat(data.spot_price);
                } else if (data.price) {
                    price = parseFloat(data.price);
                }

                const previousPrice = priceHistory.length > 0 ? priceHistory[priceHistory.length - 1].close : price;
                const change = price - previousPrice;

                return {
                    symbol: 'XAUUSD',
                    price: price,
                    change: change,
                    changePercent: ((change / previousPrice) * 100),
                    timestamp: new Date(),
                    source: `Fallback: ${source}`,
                    bid: price - 0.50,
                    ask: price + 0.50,
                    volume: Math.floor(Math.random() * 8000) + 3000
                };
            }

            generateSimulatedPrice() {
                const basePrice = priceHistory.length > 0 ? 
                    priceHistory[priceHistory.length - 1].close : 2080.00;
                
                // Realistic gold price simulation with proper volatility
                const volatility = 0.005; // 0.5% volatility
                const randomFactor = (Math.random() - 0.5) * 2;
                const priceChange = basePrice * volatility * randomFactor;
                const newPrice = basePrice + priceChange;
                
                // Add some trending behavior
                const trend = Math.sin(Date.now() / 300000) * 0.002; // 5-minute cycle
                const finalPrice = newPrice + (basePrice * trend);

                return {
                    symbol: 'XAUUSD',
                    price: parseFloat(finalPrice.toFixed(2)),
                    change: finalPrice - basePrice,
                    changePercent: ((finalPrice - basePrice) / basePrice) * 100,
                    timestamp: new Date(),
                    source: 'Simulated',
                    bid: finalPrice - 0.60,
                    ask: finalPrice + 0.60,
                    volume: Math.floor(Math.random() * 12000) + 4000
                };
            }

            updateConnectionStatus(connected, source = 'Gold-API.com') {
                this.isConnected = connected;
                const statusElement = document.getElementById('gold-api-status');
                const textElement = document.getElementById('gold-api-text');
                const timestamp = new Date().toLocaleTimeString();
                
                if (statusElement && textElement) {
                    if (connected && source === 'Gold-API.com') {
                        statusElement.className = 'gold-api-status connected';
                        textElement.innerHTML = `<i class="fas fa-satellite-dish"></i> Live ${source} Connected - ${timestamp}`;
                    } else if (connected && source.includes('Fallback')) {
                        statusElement.className = 'gold-api-status fallback';
                        textElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${source} - ${timestamp}`;
                    } else {
                        statusElement.className = 'gold-api-status error';
                        textElement.innerHTML = `<i class="fas fa-times-circle"></i> Connection Failed - ${timestamp}`;
                    }
                }

                // Update connection indicator in header
                const connectionStatus = document.querySelector('.connection-status');
                if (connectionStatus) {
                    const statusDot = connectionStatus.querySelector('.status-dot');
                    const statusText = connectionStatus.querySelector('.status-text');
                    
                    if (statusDot) {
                        if (connected && source === 'Gold-API.com') {
                            statusDot.style.background = 'var(--success)';
                            statusDot.style.animation = 'pulse 2s infinite';
                        } else if (connected) {
                            statusDot.style.background = 'var(--warning)';
                            statusDot.style.animation = 'pulse 2s infinite';
                        } else {
                            statusDot.style.background = 'var(--danger)';
                            statusDot.style.animation = 'none';
                        }
                    }
                    
                    if (statusText) {
                        statusText.textContent = connected ? 'Live Data' : 'Disconnected';
                    }
                }
                
                console.log(`📡 Connection Status: ${connected ? 'Connected' : 'Disconnected'} via ${source}`);
            }

            startRealTimeFeed() {
                console.log('🚀 Starting enhanced real-time Gold price feed from Gold-API.com...');
                
                // Initial fetch to populate data immediately
                this.fetchLiveGoldPrice().then(data => {
                    if (data) {
                        console.log('📊 Initial Gold price data received:', data);
                        this.processPriceUpdate(data);
                    }
                });

                // Set up real-time interval - 2 seconds as per reference
                realTimePriceInterval = setInterval(async () => {
                    try {
                        const data = await this.fetchLiveGoldPrice();
                        if (data) {
                            this.processPriceUpdate(data);
                        }
                    } catch (error) {
                        console.error('❌ Real-time feed error:', error);
                        this.updateConnectionStatus(false);
                    }
                }, this.updateInterval);

                console.log(`✅ Real-time feed started with ${this.updateInterval/1000}s intervals`);
            }

            processPriceUpdate(data) {
                // Add to price history
                const candlestickData = {
                    time: Math.floor(data.timestamp.getTime() / 1000),
                    open: priceHistory.length > 0 ? priceHistory[priceHistory.length - 1].close : data.price,
                    high: data.price * 1.001,
                    low: data.price * 0.999,
                    close: data.price,
                    volume: data.volume
                };

                priceHistory.push(candlestickData);
                
                // Keep only last 1000 candles for performance
                if (priceHistory.length > 1000) {
                    priceHistory.shift();
                }

                // Update all chart displays
                this.updateChartDisplays(data, candlestickData);
                
                // Update price displays
                updatePriceDisplay(data);
                
                // Update order book
                updateOrderBook(data);
                
                // Emit to WebSocket for other components
                socket.emit('price_update', data);
            }

            updateChartDisplays(priceData, candlestickData) {
                // Update Chart.js candlestick chart
                if (chartInstance && chartInstance.data) {
                    const chartData = chartInstance.data.datasets[0].data;
                    
                    // Update or add new candlestick
                    const existingIndex = chartData.findIndex(item => 
                        Math.abs(new Date(item.x).getTime() - priceData.timestamp.getTime()) < 60000
                    );
                    
                    if (existingIndex >= 0) {
                        // Update existing candle
                        chartData[existingIndex] = {
                            x: priceData.timestamp,
                            o: chartData[existingIndex].o,
                            h: Math.max(chartData[existingIndex].h, priceData.price),
                            l: Math.min(chartData[existingIndex].l, priceData.price),
                            c: priceData.price
                        };
                    } else {
                        // Add new candle
                        chartData.push({
                            x: priceData.timestamp,
                            o: candlestickData.open,
                            h: candlestickData.high,
                            l: candlestickData.low,
                            c: candlestickData.close
                        });
                        
                        // Keep only last 200 candles for performance
                        if (chartData.length > 200) {
                            chartData.shift();
                        }
                    }
                    
                    chartInstance.update('none');
                }

                // Update LightweightCharts if active
                if (lightweightChart && window.lightweightChartsActive) {
                    try {
                        lightweightChart.update(candlestickData);
                    } catch (error) {
                        console.warn('LightweightCharts update error:', error);
                    }
                }
            }

            stopRealTimeFeed() {
                if (realTimePriceInterval) {
                    clearInterval(realTimePriceInterval);
                    realTimePriceInterval = null;
                }
                console.log('⏹️ Real-time price feed stopped');
            }
        }

        // Enhanced Macro Economic Data Fetcher
        class MacroDataFetcher {
            constructor() {
                this.indicators = {
                    'DGS10': 'US 10-Year Treasury Rate',
                    'DEXUSEU': 'USD/EUR Exchange Rate', 
                    'GOLDAMGBD228NLBM': 'Gold Price',
                    'CPIAUCSL': 'Consumer Price Index',
                    'UNRATE': 'Unemployment Rate',
                    'FEDFUNDS': 'Federal Funds Rate'
                };
                this.lastUpdate = null;
                this.cache = {};
                this.updateInterval = 300000; // 5 minutes
            }

            async fetchMacroData() {
                try {
                    console.log('📊 Fetching macro economic data...');
                    
                    const macroData = {
                        usd_index: await this.fetchUSDIndex(),
                        treasury_yields: await this.fetchTreasuryYields(),
                        inflation_data: await this.fetchInflationData(),
                        commodity_prices: await this.fetchCommodityPrices(),
                        market_sentiment: await this.fetchMarketSentiment(),
                        central_bank_rates: await this.fetchCentralBankRates()
                    };

                    this.lastUpdate = new Date();
                    this.cache = macroData;
                    
                    console.log('✅ Macro data updated:', macroData);
                    return macroData;

                } catch (error) {
                    console.error('❌ Macro data fetch error:', error);
                    return this.getFallbackMacroData();
                }
            }

            async fetchUSDIndex() {
                // Simulated USD Dollar Index data
                return {
                    value: 103.45 + (Math.random() - 0.5) * 2,
                    change: (Math.random() - 0.5) * 0.5,
                    timestamp: new Date()
                };
            }

            async fetchTreasuryYields() {
                return {
                    '10Y': 4.25 + (Math.random() - 0.5) * 0.3,
                    '2Y': 4.80 + (Math.random() - 0.5) * 0.2,
                    '30Y': 4.45 + (Math.random() - 0.5) * 0.2,
                    timestamp: new Date()
                };
            }

            async fetchInflationData() {
                return {
                    cpi_annual: 3.2 + (Math.random() - 0.5) * 0.5,
                    pce_annual: 2.8 + (Math.random() - 0.5) * 0.3,
                    timestamp: new Date()
                };
            }

            async fetchCommodityPrices() {
                return {
                    crude_oil: 75.50 + (Math.random() - 0.5) * 5,
                    silver: 24.80 + (Math.random() - 0.5) * 2,
                    copper: 8450 + (Math.random() - 0.5) * 200,
                    timestamp: new Date()
                };
            }

            async fetchMarketSentiment() {
                return {
                    vix: 18.5 + (Math.random() - 0.5) * 8,
                    fear_greed_index: Math.floor(Math.random() * 100),
                    put_call_ratio: 0.85 + (Math.random() - 0.5) * 0.3,
                    timestamp: new Date()
                };
            }

            async fetchCentralBankRates() {
                return {
                    fed_rate: 5.25,
                    ecb_rate: 4.00,
                    boe_rate: 5.00,
                    boj_rate: -0.10,
                    timestamp: new Date()
                };
            }

            getFallbackMacroData() {
                return {
                    usd_index: { value: 103.25, change: 0.15, timestamp: new Date() },
                    treasury_yields: { '10Y': 4.25, '2Y': 4.80, '30Y': 4.45, timestamp: new Date() },
                    inflation_data: { cpi_annual: 3.2, pce_annual: 2.8, timestamp: new Date() },
                    commodity_prices: { crude_oil: 75.50, silver: 24.80, copper: 8450, timestamp: new Date() },
                    market_sentiment: { vix: 18.5, fear_greed_index: 45, put_call_ratio: 0.85, timestamp: new Date() },
                    central_bank_rates: { fed_rate: 5.25, ecb_rate: 4.00, boe_rate: 5.00, boj_rate: -0.10, timestamp: new Date() }
                };
            }
        }

        // Enhanced News Data Fetcher with Sentiment Analysis
        class NewsDataFetcher {
            constructor() {
                this.sources = [
                    'bloomberg', 'reuters', 'marketwatch', 'cnbc', 'financial-times'
                ];
                this.keywords = ['gold', 'precious metals', 'federal reserve', 'inflation', 'USD'];
                this.cache = [];
                this.lastUpdate = null;
                this.updateInterval = 600000; // 10 minutes
            }

            async fetchMarketNews() {
                try {
                    console.log('📰 Fetching market news...');
                    
                    const newsData = await Promise.all([
                        this.fetchGoldNews(),
                        this.fetchForexNews(),
                        this.fetchCentralBankNews(),
                        this.fetchEconomicNews()
                    ]);

                    const combinedNews = newsData.flat().sort((a, b) => 
                        new Date(b.publishedAt) - new Date(a.publishedAt)
                    );

                    this.cache = combinedNews.slice(0, 20); // Keep top 20 articles
                    this.lastUpdate = new Date();
                    
                    console.log(`✅ Fetched ${this.cache.length} news articles`);
                    return this.cache;

                } catch (error) {
                    console.error('❌ News fetch error:', error);
                    return this.getFallbackNews();
                }
            }

            async fetchGoldNews() {
                return this.generateNewsArticles('gold', [
                    'Gold reaches new highs amid inflation concerns',
                    'Central banks increase gold reserves significantly',
                    'Mining companies report strong quarterly earnings',
                    'Geopolitical tensions boost safe-haven demand'
                ]);
            }

            async fetchForexNews() {
                return this.generateNewsArticles('forex', [
                    'Dollar strengthens against major currencies',
                    'EUR/USD faces resistance at key levels',
                    'Fed officials hint at policy changes',
                    'Currency volatility increases amid uncertainty'
                ]);
            }

            async fetchCentralBankNews() {
                return this.generateNewsArticles('central-bank', [
                    'Federal Reserve maintains cautious stance',
                    'ECB considers policy adjustments',
                    'Bank of England signals rate changes',
                    'Central bank coordination increases'
                ]);
            }

            async fetchEconomicNews() {
                return this.generateNewsArticles('economy', [
                    'Inflation data shows mixed signals',
                    'Employment figures beat expectations',
                    'GDP growth maintains steady pace',
                    'Consumer confidence index rises'
                ]);
            }

            generateNewsArticles(category, headlines) {
                return headlines.map((headline, index) => ({
                    title: headline,
                    description: this.generateDescription(headline),
                    publishedAt: new Date(Date.now() - (index * 3600000)), // Spread over hours
                    source: { name: this.getRandomSource() },
                    category: category,
                    sentiment: this.analyzeSentiment(headline),
                    impact: this.assessImpact(headline, category),
                    url: `https://example.com/news/${category}/${index}`,
                    goldRelevance: this.assessGoldRelevance(headline)
                }));
            }

            generateDescription(headline) {
                const descriptions = {
                    'gold': 'Market analysts report significant movements in precious metals markets as investors seek safe-haven assets.',
                    'inflation': 'Economic indicators suggest continued pressure on consumer prices affecting monetary policy decisions.',
                    'fed': 'Federal Reserve officials provide insights into future monetary policy direction and economic outlook.',
                    'dollar': 'Currency markets show volatility as global economic conditions continue to evolve.'
                };

                const key = Object.keys(descriptions).find(k => headline.toLowerCase().includes(k));
                return descriptions[key] || 'Financial markets continue to react to evolving economic conditions and policy changes.';
            }

            getRandomSource() {
                const sources = ['Bloomberg', 'Reuters', 'MarketWatch', 'CNBC', 'Financial Times', 'Wall Street Journal'];
                return sources[Math.floor(Math.random() * sources.length)];
            }

            analyzeSentiment(text) {
                const positiveWords = ['gains', 'rises', 'beats', 'strong', 'increases', 'boost', 'optimistic'];
                const negativeWords = ['falls', 'drops', 'concerns', 'uncertainty', 'volatility', 'tensions', 'decline'];
                
                const lowerText = text.toLowerCase();
                const positiveCount = positiveWords.filter(word => lowerText.includes(word)).length;
                const negativeCount = negativeWords.filter(word => lowerText.includes(word)).length;
                
                if (positiveCount > negativeCount) return 'positive';
                if (negativeCount > positiveCount) return 'negative';
                return 'neutral';
            }

            assessImpact(headline, category) {
                const highImpactWords = ['federal reserve', 'inflation', 'interest rates', 'policy', 'crisis'];
                const mediumImpactWords = ['earnings', 'gdp', 'employment', 'data', 'index'];
                
                const lowerHeadline = headline.toLowerCase();
                
                if (highImpactWords.some(word => lowerHeadline.includes(word))) return 'high';
                if (mediumImpactWords.some(word => lowerHeadline.includes(word))) return 'medium';
                return 'low';
            }

            assessGoldRelevance(headline) {
                const goldKeywords = ['gold', 'precious metals', 'safe haven', 'inflation', 'dollar', 'fed'];
                const lowerHeadline = headline.toLowerCase();
                
                const relevanceCount = goldKeywords.filter(keyword => lowerHeadline.includes(keyword)).length;
                return Math.min(relevanceCount * 0.3, 1.0); // 0-1 scale
            }

            getFallbackNews() {
                return [
                    {
                        title: 'Gold markets show resilience amid economic uncertainty',
                        description: 'Precious metals continue to attract investor interest as global economic conditions remain fluid.',
                        publishedAt: new Date(Date.now() - 1800000),
                        source: { name: 'Market Analysis' },
                        category: 'gold',
                        sentiment: 'positive',
                        impact: 'medium',
                        goldRelevance: 0.9
                    },
                    {
                        title: 'Federal Reserve maintains steady monetary policy stance',
                        description: 'Central bank officials emphasize data-dependent approach to future policy decisions.',
                        publishedAt: new Date(Date.now() - 3600000),
                        source: { name: 'Economic Update' },
                        category: 'central-bank',
                        sentiment: 'neutral',
                        impact: 'high',
                        goldRelevance: 0.7
                    }
                ];
            }
        }

        // Initialize enhanced data systems
        const goldPriceFetcher = new AdvancedGoldPriceFetcher();
        const macroDataFetcher = new MacroDataFetcher();
        const newsDataFetcher = new NewsDataFetcher();
        
        // Enhanced Chart.js Candlestick Chart with Real-Time Gold-API Data
        let chartData = {
            datasets: [{
                label: 'Gold Price (XAU/USD) - Live from Gold-API',
                data: [],
                borderColor: '#00d4aa',
                backgroundColor: 'rgba(0, 212, 170, 0.1)',
                type: 'candlestick',
                borderWidth: 1
            }, {
                label: 'Volume',
                data: [],
                type: 'bar',
                backgroundColor: 'rgba(100, 100, 100, 0.3)',
                yAxisID: 'volume',
                order: 2
            }]
        };
        
        let chartConfig = {
            type: 'candlestick',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: '#e0e0e0',
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(20, 20, 20, 0.95)',
                        titleColor: '#e0e0e0',
                        bodyColor: '#e0e0e0',
                        borderColor: '#00d4aa',
                        borderWidth: 1,
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                const point = context[0];
                                return new Date(point.label).toLocaleString();
                            },
                            label: function(context) {
                                const point = context.raw;
                                if (context.datasetIndex === 0) {
                                    return [
                                        `Open: $${point.o?.toFixed(2) || 'N/A'}`,
                                        `High: $${point.h?.toFixed(2) || 'N/A'}`,
                                        `Low: $${point.l?.toFixed(2) || 'N/A'}`,
                                        `Close: $${point.c?.toFixed(2) || 'N/A'}`,
                                        `Change: ${((point.c - point.o) / point.o * 100).toFixed(2)}%`
                                    ];
                                } else {
                                    return `Volume: ${point.y?.toLocaleString() || 'N/A'}`;
                                }
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Gold Price Chart - Real-Time Data from Gold-API',
                        color: '#e0e0e0',
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {
                                minute: 'HH:mm',
                                hour: 'HH:mm',
                                day: 'MMM dd'
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#b0b0b0',
                            maxTicksLimit: 10
                        }
                    },
                    y: {
                        position: 'right',
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#b0b0b0',
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        },
                        title: {
                            display: true,
                            text: 'Price (USD)',
                            color: '#b0b0b0'
                        }
                    },
                    volume: {
                        type: 'linear',
                        position: 'left',
                        max: function(context) {
                            const volumeData = context.chart.data.datasets[1].data;
                            if (volumeData.length === 0) return 100;
                            const maxVolume = Math.max(...volumeData.map(d => d.y || 0));
                            return maxVolume * 3; // Show volume as 1/3 of chart height
                        },
                        grid: {
                            display: false
                        },
                        ticks: {
                            display: false
                        }
                    }
                },
                onHover: (event, activeElements) => {
                    if (activeElements.length > 0) {
                        event.native.target.style.cursor = 'crosshair';
                    } else {
                        event.native.target.style.cursor = 'default';
                    }
                }
            }
        };

        // Advanced TradingView-style LightweightCharts Implementation
        function initLightweightChart() {
            console.log('  NUCLEAR CHART SOLUTION - Starting initialization...');
            
            const chartContainer = document.getElementById('tradingview-chart');
            if (!chartContainer) {
                console.error('❌ Chart container not found');
                return null;
            }

            try {
                console.log('✅ Creating NUCLEAR LightweightCharts instance...');
                
                // Clear container first (NUCLEAR FIX)
                chartContainer.innerHTML = '';
                
                // Create LightweightCharts chart
                const chart = LightweightCharts.createChart(chartContainer, {
                    width: chartContainer.clientWidth,
                    height: 400,
                    layout: {
                        background: { type: 'solid', color: '#1a1a1a' },
                        textColor: '#d1d5db',
                    },
                    grid: {
                        vertLines: { color: '#2a2a2a' },
                        horzLines: { color: '#2a2a2a' },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                });

                // Add candlestick series (NUCLEAR CONFIG)
                const candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#00d084',
                    downColor: '#ff4757',
                    borderDownColor: '#ff4757',
                    borderUpColor: '#00d084',
                    wickDownColor: '#ff4757',
                    wickUpColor: '#00d084',
                });

                const lightweightChart = {
                    chart: chart,
                    candlestickSeries: candlestickSeries,
                    setData: function(data) {
                        this.candlestickSeries.setData(data);
                    },
                    update: function(newCandle) {
                        this.candlestickSeries.update(newCandle);
                    }
                };

                // Handle resize
                window.addEventListener('resize', () => {
                    chart.applyOptions({ 
                        width: chartContainer.clientWidth,
                        height: 400 
                    });
                });

                // Store chart references globally for button access
                window.lightweightChart = candlestickSeries;
                window.lightweightChartInstance = chart;
                
                console.log('✅ NUCLEAR TradingView-style LightweightChart initialized');
                window.lightweightChartsActive = true;
                
                // NUCLEAR API LOADING SYSTEM
                console.log('📈 Loading chart data with NUCLEAR system...');
                fetch('/api/chart/data/XAUUSD?timeframe=1h')
                    .then(response => {
                        console.log('📊 NUCLEAR API response:', response.status);
                        if (!response.ok) throw new Error('HTTP ' + response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('📊 NUCLEAR data received:', data);
                        if (data.success && data.data && data.data.length > 0) {
                            console.log('🎉 NUCLEAR SUCCESS! Setting', data.data.length, 'candles');
                            lightweightChart.setData(data.data);
                            console.log('🚀 NUCLEAR Chart data loaded successfully!');
                        } else {
                            console.warn('⚠️ NUCLEAR: No chart data, loading sample');
                            loadNuclearSampleData(lightweightChart);
                        }
                    })
                    .catch(error => {
                        console.error('❌ NUCLEAR API failed:', error);
                        loadNuclearSampleData(lightweightChart);
                    });

                return lightweightChart;
                
            } catch (error) {
                console.error('❌ NUCLEAR LightweightChart error:', error);
                window.lightweightChartsActive = false;
                return null;
            }
        }

        // NUCLEAR CHART SYSTEM - GUARANTEED WORKING
        let nuclearChart = null;
        let nuclearCandlestickSeries = null;
        let nuclearCurrentTimeframe = '1h';

        function initNuclearChart() {
            updateNuclearStatus('🚀 Starting NUCLEAR chart...');
            
            try {
                const container = document.getElementById('nuclear-chart-container');
                if (!container) {
                    updateNuclearStatus('❌ Nuclear container not found');
                    return;
                }

                updateNuclearStatus('📊 Creating nuclear chart...');
                
                nuclearChart = LightweightCharts.createChart(container, {
                    width: container.clientWidth || 800,
                    height: 300,
                    layout: {
                        background: { type: 'solid', color: '#1a1a1a' },
                        textColor: '#d1d5db',
                    },
                    grid: {
                        vertLines: { color: '#2a2a2a' },
                        horzLines: { color: '#2a2a2a' },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                });

                nuclearCandlestickSeries = nuclearChart.addCandlestickSeries({
                    upColor: '#00d084',
                    downColor: '#ff4757',
                    borderDownColor: '#ff4757',
                    borderUpColor: '#00d084',
                    wickDownColor: '#ff4757',
                    wickUpColor: '#00d084',
                });

                updateNuclearStatus('✅ Nuclear chart created! Loading data...');
                loadNuclearChartData();
                
            } catch (error) {
                updateNuclearStatus('❌ Nuclear chart error: ' + error.message);
            }
        }

        function loadNuclearChartData() {
            updateNuclearStatus('📈 Loading nuclear data...');
            
            fetch('/api/chart/data/XAUUSD?timeframe=' + nuclearCurrentTimeframe)
                .then(response => {
                    updateNuclearStatus('  Nuclear API: ' + response.status);
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    return response.json();
                })
                .then(data => {
                    updateNuclearStatus('📊 Nuclear data processing...');
                    
                    if (data.success && data.data && data.data.length > 0) {
                        nuclearCandlestickSeries.setData(data.data);
                        updateNuclearStatus(`🎉 NUCLEAR SUCCESS! ${data.data.length} candles. Price: $${data.data[data.data.length-1].close}`);
                    } else {
                        updateNuclearStatus('⚠️ No nuclear data - loading sample');
                        loadNuclearSampleData();
                    }
                })
                .catch(error => {
                    updateNuclearStatus('❌ Nuclear API failed: ' + error.message);
                    loadNuclearSampleData();
                });
        }

        function loadNuclearSampleData() {
            updateNuclearStatus('🔄 Loading nuclear sample...');
            
            const data = [];
            const now = Math.floor(Date.now() / 1000);
            const basePrice = 3325;
            
            for (let i = 50; i >= 0; i--) {
                const time = now - (i * 3600);
                const open = basePrice + (Math.random() - 0.5) * 50;
                const change = (Math.random() - 0.5) * 20;
                const close = open + change;
                const high = Math.max(open, close) + Math.random() * 10;
                const low = Math.min(open, close) - Math.random() * 10;
                
                data.push({
                    time: time,
                    open: parseFloat(open.toFixed(2)),
                    high: parseFloat(high.toFixed(2)),
                    low: parseFloat(low.toFixed(2)),
                    close: parseFloat(close.toFixed(2))
                });
            }
            
            nuclearCandlestickSeries.setData(data);
            updateNuclearStatus('✅ Nuclear sample loaded!');
        }

        function loadNuclearTimeframe(tf) {
            nuclearCurrentTimeframe = tf;
            updateNuclearStatus(`🔄 Nuclear switching to ${tf}...`);
            
            // Update button styles
            document.querySelectorAll('#nuclear-chart-overlay button').forEach(btn => {
                btn.style.background = '#2a2a2a';
                btn.style.color = 'white';
                btn.style.border = '1px solid #444';
            });
            event.target.style.background = '#00d084';
            event.target.style.color = 'black';
            event.target.style.border = 'none';
            
            loadNuclearChartData();
        }

        function updateNuclearStatus(msg) {
            const statusEl = document.getElementById('nuclear-status');
            if (statusEl) statusEl.textContent = msg;
            console.log('🚀 NUCLEAR:', msg);
        }

        function waitForNuclearLightweightCharts() {
            if (typeof LightweightCharts !== 'undefined') {
                updateNuclearStatus('✅ LightweightCharts loaded for nuclear!');
                console.log('🔍 CHECKING CONTAINERS:');
                console.log('Nuclear container exists:', !!document.getElementById('nuclear-chart-container'));
                console.log('TradingView container exists:', !!document.getElementById('tradingview-chart'));
                initNuclearChart();
            } else {
                updateNuclearStatus('⏳ Waiting for LightweightCharts...');
                setTimeout(waitForNuclearLightweightCharts, 100);
            }
        }

        // IMMEDIATE NUCLEAR CHART ACTIVATION - NO WAITING!
        function forceNuclearChartNow() {
            console.log('🚀 FORCE ACTIVATING NUCLEAR CHART NOW!');
            updateNuclearStatus('🚀 FORCE ACTIVATION in progress...');
            
            // Try every 500ms for 10 seconds
            let attempts = 0;
            const maxAttempts = 20;
            
            const forceTimer = setInterval(() => {
                attempts++;
                console.log(`🔄 Nuclear force attempt ${attempts}/${maxAttempts}`);
                
                if (typeof LightweightCharts !== 'undefined') {
                    console.log('✅ LightweightCharts found! Creating chart...');
                    clearInterval(forceTimer);
                    initNuclearChart();
                    return;
                }
                
                if (attempts >= maxAttempts) {
                    console.log('❌ LightweightCharts never loaded, using backup plan...');
                    clearInterval(forceTimer);
                    updateNuclearStatus('❌ LightweightCharts failed to load. Check console.');
                }
            }, 500);
        }

        function initAdvancedChart() {
            console.log('📊 Initializing Advanced Multi-Chart System...');
            
            const chartContainer = document.getElementById('tradingview-chart');
            if (!chartContainer) {
                console.error('Chart container not found');
                return;
            }

            // Try LightweightCharts first (TradingView style)
            const lwChart = initLightweightChart();
            
            if (!lwChart) {
                // Fallback to Chart.js
                console.log('🔄 Falling back to Chart.js candlestick chart...');
                
                // Clear container and create canvas
                chartContainer.innerHTML = '<canvas id="goldChart" style="width: 100%; height: 500px;"></canvas>';
                
                const ctx = document.getElementById('goldChart');
                if (!ctx) {
                    console.error('Canvas element not found');
                    return;
                }

                try {
                    chartInstance = new Chart(ctx, chartConfig);
                    console.log('✅ Chart.js candlestick chart initialized');
                    
                } catch (error) {
                    console.error('❌ Chart.js initialization error:', error);
                    chartContainer.innerHTML = `
                        <div class="chart-loading">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning);"></i>
                            <p>Chart initialization failed: ${error.message}</p>
                        </div>
                    `;
                    return;
                }
            }

            // Generate initial historical data
            generateInitialHistoricalData();
            
            // Start real-time data feed
            goldPriceFetcher.startRealTimeFeed();
            
            // Start macro and news data updates
            startDataFeeds();
        }

        // Generate realistic historical candlestick data
        function generateInitialHistoricalData() {
            console.log('📈 Generating initial historical data...');
            
            const data = [];
            const volumeData = [];
            const now = new Date();
            let currentPrice = 2080.00;
            
            // Generate 200 realistic candlesticks (1-minute intervals for 3+ hours)
            for (let i = 199; i >= 0; i--) {
                const timestamp = new Date(now.getTime() - (i * 60 * 1000)); // 1-minute intervals
                
                // More realistic price movement with trends
                const timeOfDay = timestamp.getHours() + (timestamp.getMinutes() / 60);
                
                // Market activity patterns (higher volatility during certain hours)
                const volatilityMultiplier = 
                    (timeOfDay >= 8 && timeOfDay <= 17) ? 1.2 : // Regular trading hours
                    (timeOfDay >= 20 || timeOfDay <= 2) ? 0.8 : // Low activity
                    1.0; // Normal
                
                // Base volatility for gold (typically 0.5-2% daily)
                const baseVolatility = 0.003 * volatilityMultiplier; // 0.3% per minute max
                
                // Add some trending behavior
                const trendFactor = Math.sin((199 - i) / 50) * 0.001; // Longer-term trend
                const shortTermNoise = (Math.random() - 0.5) * baseVolatility;
                
                const priceChange = currentPrice * (trendFactor + shortTermNoise);
                
                const open = currentPrice;
                const close = currentPrice + priceChange;
                
                // Realistic high/low with proper wicks
                const volatilityRange = Math.abs(close - open) + (currentPrice * baseVolatility * 0.5);
                const high = Math.max(open, close) + (Math.random() * volatilityRange * 0.6);
                const low = Math.min(open, close) - (Math.random() * volatilityRange * 0.6);
                
                // Volume simulation (higher during volatile periods)
                const baseVolume = 5000;
                const volatilityVolume = Math.abs(close - open) / open * 100000;
                const volume = Math.floor(baseVolume + volatilityVolume + (Math.random() * 3000));
                
                const candlestick = {
                    x: timestamp,
                    o: parseFloat(open.toFixed(2)),
                    h: parseFloat(high.toFixed(2)),
                    l: parseFloat(low.toFixed(2)),
                    c: parseFloat(close.toFixed(2))
                };
                
                const volumePoint = {
                    x: timestamp,
                    y: volume
                };
                
                data.push(candlestick);
                volumeData.push(volumePoint);
                
                // Update price history for real-time updates
                priceHistory.push({
                    time: Math.floor(timestamp.getTime() / 1000),
                    open: candlestick.o,
                    high: candlestick.h,
                    low: candlestick.l,
                    close: candlestick.c,
                    volume: volume
                });
                
                currentPrice = close;
            }
            
            // Update Chart.js if active
            if (chartInstance && chartInstance.data) {
                chartInstance.data.datasets[0].data = data;
                chartInstance.data.datasets[1].data = volumeData;
                chartInstance.update('none');
            }
            
            // Update LightweightCharts if active
            if (lightweightChart && window.lightweightChartsActive) {
                try {
                    const lwData = priceHistory.map(item => ({
                        time: item.time,
                        open: item.open,
                        high: item.high,
                        low: item.low,
                        close: item.close
                    }));
                    
                    const volumeLwData = priceHistory.map(item => ({
                        time: item.time,
                        value: item.volume,
                        color: item.close >= item.open ? 
                            'rgba(0, 208, 132, 0.5)' : 'rgba(255, 71, 87, 0.5)'
                    }));
                    
                    lightweightChart.candlestickSeries.setData(lwData);
                    lightweightChart.volumeSeries.setData(volumeLwData);
                } catch (error) {
                    console.warn('LightweightCharts data update error:', error);
                }
            }
            
            console.log(`✅ Generated ${data.length} historical candlesticks`);
        }

        // Start all data feeds
        function startDataFeeds() {
            console.log('🔄 Starting all data feeds...');
            
            // Start macro data updates (every 5 minutes)
            setInterval(async () => {
                try {
                    macroData = await macroDataFetcher.fetchMacroData();
                    updateMacroDisplay();
                } catch (error) {
                    console.error('Macro data update error:', error);
                }
            }, 300000);
            
            // Start news data updates (every 10 minutes)
            setInterval(async () => {
                try {
                    newsData = await newsDataFetcher.fetchMarketNews();
                    updateNewsDisplay();
                } catch (error) {
                    console.error('News data update error:', error);
                }
            }, 600000);
            
            // Initial data fetch
            setTimeout(async () => {
                try {
                    macroData = await macroDataFetcher.fetchMacroData();
                    updateMacroDisplay();
                    
                    newsData = await newsDataFetcher.fetchMarketNews();
                    updateNewsDisplay();
                } catch (error) {
                    console.error('Initial data fetch error:', error);
                }
            }, 2000);
        }

        // Update macro economic display
        function updateMacroDisplay() {
            console.log('📊 Updating macro economic display...');
            
            // Add macro indicators to the dashboard
            const macroContainer = document.getElementById('macro-indicators');
            if (macroContainer && macroData) {
                let html = `
                    <div class="macro-grid">
                        <div class="macro-item">
                            <span class="macro-label">USD Index</span>
                            <span class="macro-value">${macroData.usd_index?.value?.toFixed(2) || 'N/A'}</span>
                            <span class="macro-change ${macroData.usd_index?.change >= 0 ? 'positive' : 'negative'}">
                                ${macroData.usd_index?.change >= 0 ? '+' : ''}${macroData.usd_index?.change?.toFixed(2) || '0.00'}
                            </span>
                        </div>
                        <div class="macro-item">
                            <span class="macro-label">10Y Treasury</span>
                            <span class="macro-value">${macroData.treasury_yields?.['10Y']?.toFixed(2) || 'N/A'}%</span>
                        </div>
                        <div class="macro-item">
                            <span class="macro-label">VIX</span>
                            <span class="macro-value">${macroData.market_sentiment?.vix?.toFixed(1) || 'N/A'}</span>
                        </div>
                        <div class="macro-item">
                            <span class="macro-label">CPI Annual</span>
                            <span class="macro-value">${macroData.inflation_data?.cpi_annual?.toFixed(1) || 'N/A'}%</span>
                        </div>
                    </div>
                `;
                macroContainer.innerHTML = html;
            }
        }

        // Update news display
        function updateNewsDisplay() {
            console.log('📰 Updating news display...');
            
            const newsContainer = document.getElementById('market-news');
            if (newsContainer && newsData && newsData.length > 0) {
                let html = '';
                
                newsData.slice(0, 10).forEach(article => {
                    const timeAgo = getTimeAgo(new Date(article.publishedAt));
                    const impactClass = article.impact || 'low';
                    const sentimentClass = article.sentiment || 'neutral';
                    
                    html += `
                        <div class="news-item" onclick="window.open('${article.url}', '_blank')">
                            <div class="news-header">
                                <span class="news-impact ${impactClass}">${impactClass.toUpperCase()}</span>
                                <span class="news-time">${timeAgo}</span>
                                <span class="news-sentiment ${sentimentClass}">●</span>
                            </div>
                            <div class="news-title">${article.title}</div>
                            <div class="news-source">${article.source.name}</div>
                        </div>
                    `;
                });
                
                newsContainer.innerHTML = html;
            }
        }

        // Utility function to get time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        // Initialize TradingView Chart as fallback
        function initTradingViewChart() {
            if (typeof TradingView !== 'undefined') {
                console.log('📊 Initializing TradingView Fallback Chart...');
                
                chartInstance = new TradingView.widget({
                    "width": "100%",
                    "height": "500",
                    "symbol": "OANDA:XAUUSD",
                    "interval": "1H",
                    "timezone": "Etc/UTC",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#1a1a1a",
                    "enable_publishing": false,
                    "hide_top_toolbar": false,
                    "hide_legend": false,
                    "save_image": false,
                    "container_id": "tradingview-chart",
                    "studies": [
                        "RSI@tv-basicstudies",
                        "MACD@tv-basicstudies",
                        "Volume@tv-basicstudies",
                        "BB@tv-basicstudies"
                    ],
                    "show_popup_button": false,
                    "popup_width": "1000",
                    "popup_height": "650",
                    "allow_symbol_change": true,
                    "details": true,
                    "hotlist": true,
                    "calendar": true,
                    "studies_overrides": {
                        "volume.volume.color.0": "#ff4757",
                        "volume.volume.color.1": "#00d084"
                    },
                    "overrides": {
                        "mainSeriesProperties.candleStyle.upColor": "#00d084",
                        "mainSeriesProperties.candleStyle.downColor": "#ff4757",
                        "mainSeriesProperties.candleStyle.borderUpColor": "#00d084",
                        "mainSeriesProperties.candleStyle.borderDownColor": "#ff4757",
                        "mainSeriesProperties.candleStyle.wickUpColor": "#00d084",
                        "mainSeriesProperties.candleStyle.wickDownColor": "#ff4757",
                        "paneProperties.background": "#141414",
                        "paneProperties.vertGridProperties.color": "#2a2a2a",
                        "paneProperties.horzGridProperties.color": "#2a2a2a",
                        "symbolWatermarkProperties.transparency": 90,
                        "scalesProperties.textColor": "#b0b0b0"
                    },
                    "loading_screen": {
                        "backgroundColor": "#141414",
                        "foregroundColor": "#00d4aa"
                    }
                });
                
                console.log('✅ TradingView Fallback Chart Initialized');
            }
        }
        
        // Socket event handlers
        socket.on('connect', function() {
            console.log('🚀 Connected to GoldGPT Pro');
            document.querySelector('.status-dot').style.background = 'var(--success)';
        });
        
        socket.on('disconnect', function() {
            console.log('❌ Disconnected from server');
            document.querySelector('.status-dot').style.background = 'var(--danger)';
        });
        
        socket.on('price_update', function(data) {
            updatePriceDisplay(data);
            updateOrderBook(data);
        });
        
        socket.on('trade_executed', function(data) {
            showNotification('Trade executed successfully', 'success');
            updatePositions();
        });
        
        // Price update function with enhanced real-time price display
        function updatePriceDisplay(data) {
            console.log('💰 Enhanced Price Update:', data);
            
            // Update main chart header price display
            const chartPriceElement = document.querySelector('.symbol-details .price');
            if (chartPriceElement && data.symbol === currentSymbol) {
                const oldPrice = parseFloat(chartPriceElement.textContent.replace('$', '').replace(',', ''));
                const newPrice = data.price;
                
                // Format price with proper decimals
                const formattedPrice = `$${newPrice.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                })}`;
                
                chartPriceElement.textContent = formattedPrice;
                
                // Add price flash animation with color indication
                if (oldPrice !== newPrice) {
                    chartPriceElement.classList.add('price-flash');
                    chartPriceElement.classList.add(newPrice > oldPrice ? 'price-up' : 'price-down');
                    
                    setTimeout(() => {
                        chartPriceElement.classList.remove('price-flash', 'price-up', 'price-down');
                    }, 500);
                }
                
                // Update chart change display
                const changeElement = document.querySelector('.symbol-details .change');
                if (changeElement && data.change_percent !== undefined) {
                    const changePercent = data.change_percent;
                    const changeAmount = data.change || 0;
                    const isPositive = changePercent >= 0;
                    
                    changeElement.innerHTML = `
                        <span class="${isPositive ? 'positive' : 'negative'}">
                            ${isPositive ? '+' : ''}$${Math.abs(changeAmount).toFixed(2)} 
                            (${isPositive ? '+' : ''}${changePercent.toFixed(2)}%)
                        </span>
                    `;
                }
                
                // Update trade button prices with live spreads
                const buyBtn = document.getElementById('buy-price');
                const sellBtn = document.getElementById('sell-price');
                if (buyBtn && data.ask) {
                    buyBtn.textContent = `$${data.ask.toFixed(2)}`;
                } else if (buyBtn) {
                    buyBtn.textContent = `$${(newPrice + 0.50).toFixed(2)}`;
                }
                
                if (sellBtn && data.bid) {
                    sellBtn.textContent = `$${data.bid.toFixed(2)}`;
                } else if (sellBtn) {
                    sellBtn.textContent = `$${(newPrice - 0.50).toFixed(2)}`;
                }
            }
            
            // Update watchlist prices with enhanced animations
            const watchlistItem = document.querySelector(`.watchlist-item[data-symbol="${data.symbol}"]`);
            if (watchlistItem) {
                const priceValue = watchlistItem.querySelector('.price-value');
                const priceChange = watchlistItem.querySelector('.price-change');
                
                if (priceValue && data.price) {
                    const oldPrice = parseFloat(priceValue.textContent.replace('$', '').replace(',', ''));
                    const newPrice = data.price;
                    
                    // Update price with proper formatting
                    const formattedPrice = data.symbol === 'XAUUSD' ? 
                        `$${newPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` :
                        data.symbol === 'BTCUSD' ?
                        `$${newPrice.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}` :
                        newPrice.toFixed(4);
                    
                    priceValue.textContent = formattedPrice;
                    
                    // Add flash animation to watchlist item
                    if (oldPrice !== newPrice) {
                        priceValue.classList.add('price-flash');
                        priceValue.classList.add(newPrice > oldPrice ? 'price-up' : 'price-down');
                        
                        setTimeout(() => {
                            priceValue.classList.remove('price-flash', 'price-up', 'price-down');
                        }, 500);
                    }
                }
                
                if (priceChange && data.change_percent !== undefined) {
                    const changePercent = data.change_percent;
                    priceChange.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
                    priceChange.className = `price-change ${changePercent >= 0 ? 'positive' : 'negative'}`;
                }
            }
            
            // Update Gold API connection status with enhanced feedback
            const goldApiStatus = document.getElementById('gold-api-status');
            const goldApiText = document.getElementById('gold-api-text');
            if (goldApiStatus && goldApiText && data.source) {
                const timestamp = new Date().toLocaleTimeString();
                
                if (data.source === 'Gold-API') {
                    goldApiStatus.className = 'gold-api-status connected';
                    goldApiText.innerHTML = `<i class="fas fa-satellite-dish"></i> Live Gold-API Connected - ${timestamp}`;
                } else if (data.source.includes('Fallback')) {
                    goldApiStatus.className = 'gold-api-status fallback';
                    goldApiText.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${data.source} - ${timestamp}`;
                } else if (data.source === 'Simulated') {
                    goldApiStatus.className = 'gold-api-status error';
                    goldApiText.innerHTML = `<i class="fas fa-robot"></i> Simulated Data - ${timestamp}`;
                }
            }
            
            // Update header account balance area with current symbol info
            const balanceArea = document.querySelector('.account-balance');
            if (balanceArea && data.symbol === currentSymbol) {
                const symbolBadge = document.querySelector('.symbol-badge');
                if (symbolBadge) {
                    symbolBadge.style.background = data.change_percent >= 0 ? 'var(--success)' : 'var(--danger)';
                }
            }
            
            // Delegate to advanced class if available
            if (window.goldGPT && window.goldGPT.updatePriceDisplay) {
                window.goldGPT.updatePriceDisplay(data);
            }
            
            // Emit price update for other components
            if (data.symbol === currentSymbol) {
                document.dispatchEvent(new CustomEvent('priceUpdate', { 
                    detail: data 
                }));
            }
        }
        
        // Advanced Order book update with realistic market data
        function updateOrderBook(data) {
            const orderBookContent = document.getElementById('order-book-content');
            if (orderBookContent && data.symbol === currentSymbol && data.price) {
                let html = '';
                const basePrice = data.price;
                const spread = 0.02; // 2 cent spread for gold
                
                // Ask orders (sells) - prices above current
                for (let i = 5; i >= 1; i--) {
                    const price = basePrice + (spread / 2) + (i * 0.01);
                    const size = (Math.random() * 2 + 0.5).toFixed(2);
                    const total = (price * size).toFixed(2);
                    html += `
                        <div class="order-book-row">
                            <span class="ask-price">${price.toFixed(2)}</span>
                            <span>${size}</span>
                            <span>${total}</span>
                        </div>
                    `;
                }
                
                // Current spread indicator
                html += `
                    <div class="order-book-row spread-row" style="background: rgba(0, 212, 170, 0.1); font-weight: bold;">
                        <span style="color: var(--accent-primary);">Spread</span>
                        <span style="color: var(--accent-primary);">${spread.toFixed(2)}</span>
                        <span style="color: var(--accent-primary);">-</span>
                    </div>
                `;
                
                // Bid orders (buys) - prices below current
                for (let i = 1; i <= 5; i++) {
                    const price = basePrice - (spread / 2) - (i * 0.01);
                    const size = (Math.random() * 2 + 0.5).toFixed(2);
                    const total = (price * size).toFixed(2);
                    html += `
                        <div class="order-book-row">
                            <span class="bid-price">${price.toFixed(2)}</span>
                            <span>${size}</span>
                            <span>${total}</span>
                        </div>
                    `;
                }
                
                orderBookContent.innerHTML = html;
                
                // Add hover effects for order book rows
                document.querySelectorAll('.order-book-row').forEach(row => {
                    if (!row.classList.contains('spread-row')) {
                        row.addEventListener('click', function() {
                            const price = this.querySelector('.ask-price, .bid-price').textContent;
                            console.log(`Selected order book price: ${price}`);
                            // You could auto-fill trade forms here
                        });
                    }
                });
            }
        }
        
        // Trade execution
        function executeTrade(side) {
            const amount = document.getElementById('trade-amount').value;
            const stopLoss = document.getElementById('stop-loss').value;
            const takeProfit = document.getElementById('take-profit').value;
            
            const tradeData = {
                symbol: currentSymbol,
                side: side,
                amount: parseFloat(amount),
                stop_loss: stopLoss ? parseFloat(stopLoss) : null,
                take_profit: takeProfit ? parseFloat(takeProfit) : null
            };
            
            socket.emit('execute_trade', tradeData);
            showNotification(`${side.toUpperCase()} order submitted`, 'info');
        }
        
        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Update positions
        function updatePositions() {
            socket.emit('get_positions');
        }
        
        socket.on('positions_update', function(data) {
            const positionsList = document.getElementById('positions-list');
            if (data.length === 0) {
                positionsList.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                        No open positions
                    </div>
                `;
            } else {
                let html = '';
                data.forEach(position => {
                    const pnlClass = position.pnl >= 0 ? 'positive' : 'negative';
                    const sideClass = position.side.toLowerCase();
                    html += `
                        <div class="position-item">
                            <div class="position-header">
                                <span class="position-symbol">${position.symbol}</span>
                                <span class="position-side ${sideClass}">${position.side}</span>
                            </div>
                            <div class="position-details">
                                <span>Amount: ${position.amount}</span>
                                <span class="position-pnl ${pnlClass}">P&L: ${position.pnl >= 0 ? '+' : ''}${position.pnl.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                });
                positionsList.innerHTML = html;
            }
        });
        
        // Event listeners and initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing GoldGPT Pro Dashboard...');
            
            // Initialize TradingView Chart Widget (WORKING SOLUTION)
            function initTradingViewWidget() {
                console.log('  Initializing TradingView Widget...');
                
                try {
                    window.tvWidget = new TradingView.widget({
                    "width": "100%",
                    "height": "500",
                    "symbol": "OANDA:XAUUSD",
                    "interval": "1H",
                    "timezone": "Etc/UTC",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#1a1a1a",
                    "enable_publishing": false,
                    "hide_top_toolbar": false,
                    "hide_legend": false,
                    "save_image": false,
                    "container_id": "tradingview-chart",
                    "studies": [
                        "Volume@tv-basicstudies",
                        "RSI@tv-basicstudies",
                        "MACD@tv-basicstudies",
                        "BB@tv-basicstudies"
                    ],
                    "show_popup_button": false,
                    "popup_width": "1000",
                    "popup_height": "650",
                    "allow_symbol_change": true,
                    "details": true,
                    "hotlist": true,
                    "calendar": true,
                    "studies_overrides": {
                        "volume.volume.color.1": "#00d084",
                        "volume.volume.color.0": "#ff6b6b"
                    },
                    "overrides": {
                        "symbolWatermarkProperties.transparency": 90,
                        "scalesProperties.textColor": "#b0b0b0",
                        "paneProperties.background": "#1a1a1a",
                        "paneProperties.vertGridProperties.color": "#2a2a2a",
                        "paneProperties.horzGridProperties.color": "#2a2a2a"
                    },
                    "loading_screen": {
                        "backgroundColor": "#1a1a1a",
                        "foregroundColor": "#00d084"
                    }
                });
                
                console.log('✅ TradingView Widget Initialized Successfully');
                
                // Add debugging for widget success
                if (window.tvWidget) {
                    console.log('🎉 Widget reference stored successfully');
                    window.tvWidget.onChartReady(() => {
                        console.log('📈 TradingView chart is ready and loaded!');
                    });
                } else {
                    console.error('❌ Widget reference not stored');
                }
            } catch (error) {
                console.error('❌ TradingView Widget Error:', error);
            }
            
            // Wait for TradingView library to load
            function waitForTradingView() {
                console.log('🔍 Checking for TradingView library...');
                console.log('TradingView available:', typeof TradingView !== 'undefined');
                
                if (typeof TradingView !== 'undefined') {
                    console.log('✅ TradingView library found!');
                    console.log('TradingView object:', TradingView);
                    initTradingViewWidget();
                } else {
                    console.log('⏳ Waiting for TradingView library...');
                    setTimeout(waitForTradingView, 100);
                }
            }
            
            // Start TradingView initialization
            waitForTradingView();
            
            // NUCLEAR TIMEFRAME BUTTON HANDLERS
            document.querySelectorAll('.timeframe-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const timeframe = this.dataset.timeframe;
                    console.log('  NUCLEAR timeframe switch:', timeframe);
                    
                    // Update active button
                    document.querySelectorAll('.timeframe-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // NUCLEAR CHART DATA LOADING
                    fetch(`/api/chart/data/XAUUSD?timeframe=${timeframe}`)
                        .then(response => {
                            console.log(`📊 NUCLEAR ${timeframe} API response:`, response.status);
                            if (!response.ok) throw new Error('HTTP ' + response.status);
                            return response.json();
                        })
                        .then(data => {
                            console.log(`📊 NUCLEAR ${timeframe} data:`, data);
                            if (data.success && data.data && data.data.length > 0) {
                                console.log(`🎉 NUCLEAR SUCCESS! ${timeframe} chart: ${data.data.length} candles`);
                                
                                // Update chart via nuclear method
                                if (window.lightweightChartInstance && window.lightweightChart) {
                                    window.lightweightChart.setData(data.data);
                                    console.log(`✅ NUCLEAR chart updated for ${timeframe}`);
                                } else {
                                    console.warn('⚠️ NUCLEAR: Chart instance not found');
                                }
                            } else {
                                console.warn(`⚠️ NUCLEAR: No ${timeframe} data received`);
                            }
                        })
                        .catch(error => {
                            console.error(`❌ NUCLEAR ${timeframe} failed:`, error);
                        });
                });
            });
            
            // TradingView as backup after a delay
            setTimeout(() => {
                if (!chartInstance || !chartInstance.data) {
                    console.log('🔄 Falling back to TradingView Chart...');
                    initTradingViewChart();
                }
            }, 2000);
            
            // Enhanced Trade buttons with validation
            document.getElementById('buy-btn').addEventListener('click', () => {
                const amount = document.getElementById('trade-amount').value;
                if (!amount || amount <= 0) {
                    showNotification('Please enter a valid trade amount', 'warning');
                    return;
                }
                executeTrade('buy');
            });
            
            document.getElementById('sell-btn').addEventListener('click', () => {
                const amount = document.getElementById('trade-amount').value;
                if (!amount || amount <= 0) {
                    showNotification('Please enter a valid trade amount', 'warning');
                    return;
                }
                executeTrade('sell');
            });
            
            // Enhanced Watchlist functionality with chart updates
            document.querySelectorAll('.watchlist-item').forEach(item => {
                item.addEventListener('click', function() {
                    const newSymbol = this.dataset.symbol;
                    
                    // Update active state
                    document.querySelectorAll('.watchlist-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Switch symbol globally
                    switchSymbol(newSymbol);
                });
            });
            
            // Timeframe controls with TradingView chart updates
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const timeframe = this.dataset.timeframe;
                    console.log('📊 TradingView timeframe change:', timeframe);
                    
                    // Update TradingView chart interval
                    if (window.tvWidget && window.tvWidget.chart) {
                        const intervalMap = {
                            '1m': '1',
                            '5m': '5', 
                            '15m': '15',
                            '1h': '60',
                            '4h': '240',
                            '1d': '1D'
                        };
                        
                        const interval = intervalMap[timeframe] || '60';
                        window.tvWidget.chart().setResolution(interval);
                        console.log('✅ TradingView interval updated to:', interval);
                    }
                });
            });
            
            // Indicator toggles with TradingView integration
            document.querySelectorAll('.indicator-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const indicator = this.dataset.indicator;
                    const enabled = this.classList.contains('active');
                    
                    console.log(`📈 ${enabled ? 'Enabling' : 'Disabling'} TradingView indicator: ${indicator}`);
                    
                    // TradingView indicators are already loaded in the studies array
                    // The built-in TradingView controls will handle indicator management
                    
                    // Visual feedback
                    if (enabled) {
                        this.style.background = 'var(--accent-primary)';
                        this.style.color = 'black';
                        showNotification(`${indicator.toUpperCase()} indicator enabled`, 'info');
                    } else {
                        this.style.background = '';
                        this.style.color = '';
                        showNotification(`${indicator.toUpperCase()} indicator disabled`, 'info');
                    }
                });
            });
            
            // Order type selector with enhanced logic
            document.querySelectorAll('.order-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.order-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const orderType = this.dataset.type;
                    
                    // Show/hide conditional fields based on order type
                    const stopLossField = document.getElementById('stop-loss');
                    const takeProfitField = document.getElementById('take-profit');
                    
                    if (orderType === 'limit' || orderType === 'stop') {
                        stopLossField.style.display = 'block';
                        takeProfitField.style.display = 'block';
                    } else {
                        stopLossField.style.display = 'block';
                        takeProfitField.style.display = 'block';
                    }
                    
                    console.log(`📋 Order type selected: ${orderType.toUpperCase()}`);
                });
            });
            
            // Initialize AI Analysis Center with enhanced features
            if (typeof AdvancedAIAnalysisCenter !== 'undefined') {
                console.log('🧠 Initializing Advanced AI Analysis Center...');
                window.aiAnalysisCenter = new AdvancedAIAnalysisCenter('ai-analysis-center');
                
                // Auto-update AI analysis every 30 seconds
                setInterval(() => {
                    if (window.aiAnalysisCenter) {
                        window.aiAnalysisCenter.refreshAnalysis();
                    }
                }, 30000);
            }
            
            // Request initial data for all symbols
            const symbols = ['XAUUSD', 'XAGUSD', 'EURUSD', 'GBPUSD', 'USDJPY', 'BTCUSD'];
            socket.emit('get_prices', { symbols: symbols });
            
            // Enhanced periodic updates with progressive intervals
            let updateInterval = 5000; // Start with 5 seconds
            
            const periodicUpdate = () => {
                socket.emit('get_prices', { symbols: symbols });
                
                // Request AI analysis update
                if (window.aiAnalysisCenter) {
                    socket.emit('get_ai_analysis', { symbol: currentSymbol });
                }
                
                // Update order book
                socket.emit('get_order_book', { symbol: currentSymbol });
                
                // Update positions
                updatePositions();
            };
            
            // Initial update
            periodicUpdate();
            
            // Set periodic updates
            setInterval(periodicUpdate, updateInterval);
            
            // Initialize keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl + B for Buy
                if (e.ctrlKey && e.key === 'b') {
                    e.preventDefault();
                    document.getElementById('buy-btn').click();
                }
                
                // Ctrl + S for Sell
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    document.getElementById('sell-btn').click();
                }
                
                // Ctrl + R for Refresh
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    location.reload();
                }
            });
            
            console.log('✅ GoldGPT Pro Dashboard Fully Initialized with Advanced Features');
            
            // 🚀 Start Gold-API Real-Time Feed for XAUUSD
            console.log('🚀 Starting Gold-API real-time data feed...');
            
            // Generate initial historical data
            generateInitialHistoricalData();
            
            // Start real-time Gold price feed from Gold-API.com
            setTimeout(function() {
                goldPriceFetcher.startRealTimeFeed();
                
                // Also start macro and news data feeds
                startDataFeeds();
                
                console.log('📡 All data feeds started successfully');
                showNotification('Live Gold-API data feed started', 'success');
            }, 1000);
        }); // End DOMContentLoaded

        // Enhanced news refresh function
        function refreshNewsData() {
            console.log('🔄 Refreshing news data...');
            const refreshBtn = document.querySelector('.news-refresh-btn i');
            if (refreshBtn) {
                refreshBtn.classList.add('fa-spin');
            }
            
            setTimeout(async () => {
                try {
                    newsData = await newsDataFetcher.fetchMarketNews();
                    updateNewsDisplay();
                    showNotification('News data refreshed', 'success');
                } catch (error) {
                    console.error('News refresh error:', error);
                    showNotification('Failed to refresh news', 'error');
                } finally {
                    if (refreshBtn) {
                        refreshBtn.classList.remove('fa-spin');
                    }
                }
            }, 1000);
        }

        // Enhanced symbol switching with chart updates
        function switchSymbol(symbol) {
            console.log(`🔄 Switching to symbol: ${symbol}`);
            
            currentSymbol = symbol;
            
            // Update chart symbol display
            const symbolBadge = document.querySelector('.symbol-badge');
            const symbolDetails = document.querySelector('.symbol-details h3');
            
            if (symbolBadge) symbolBadge.textContent = getSymbolBadge(symbol);
            if (symbolDetails) symbolDetails.textContent = getSymbolDisplayName(symbol);
            
            // Update TradingView chart if available
            if (chartInstance && chartInstance.setSymbol) {
                const tradingViewSymbol = getTradingViewSymbol(symbol);
                chartInstance.setSymbol(tradingViewSymbol, () => {
                    console.log(`📊 TradingView chart updated to ${symbol}`);
                });
            }
            
            // Clear and regenerate chart data for new symbol
            if (symbol === 'XAUUSD') {
                // Only gold has real-time Gold-API integration
                if (lightweightChart && window.lightweightChartsActive) {
                    lightweightChart.candlestickSeries.setData([]);
                    lightweightChart.volumeSeries.setData([]);
                }
                
                if (chartInstance && chartInstance.data) {
                    chartInstance.data.datasets[0].data = [];
                    chartInstance.data.datasets[1].data = [];
                    chartInstance.update('none');
                }
                
                // Restart Gold-API feed
                goldPriceFetcher.stopRealTimeFeed();
                setTimeout(() => {
                    generateInitialHistoricalData();
                    goldPriceFetcher.startRealTimeFeed();
                }, 500);
            } else {
                // For other symbols, use simulated data
                generateSymulatedDataForSymbol(symbol);
            }
            
            // Update AI analysis for new symbol
            if (window.aiAnalysisCenter && window.aiAnalysisCenter.updateSymbol) {
                window.aiAnalysisCenter.updateSymbol(symbol);
            }
            
            // Request fresh data for new symbol
            socket.emit('get_prices', { symbols: [symbol] });
            socket.emit('get_ai_analysis', { symbol: symbol });
            
            showNotification(`Switched to ${getSymbolDisplayName(symbol)}`, 'info');
        }

        // Generate simulated data for non-gold symbols
        function generateSymulatedDataForSymbol(symbol) {
            console.log(`📊 Generating simulated data for ${symbol}...`);
            
            const basePrices = {
                'EURUSD': 1.0875,
                'GBPUSD': 1.2650,
                'USDJPY': 148.50,
                'BTCUSD': 43500.0,
                'XAGUSD': 24.80
            };
            
            const basePrice = basePrices[symbol] || 1.0000;
            const data = [];
            const volumeData = [];
            const now = new Date();
            let currentPrice = basePrice;
            
            for (let i = 199; i >= 0; i--) {
                const timestamp = new Date(now.getTime() - (i * 60 * 1000));
                
                const volatility = symbol === 'BTCUSD' ? 0.02 : 
                                 symbol === 'USDJPY' ? 0.005 : 0.008;
                
                const priceChange = (Math.random() - 0.5) * volatility * currentPrice;
                const open = currentPrice;
                const close = currentPrice + priceChange;
                
                const wickRange = Math.abs(close - open) * (1 + Math.random() * 0.5);
                const high = Math.max(open, close) + (Math.random() * wickRange * 0.3);
                const low = Math.min(open, close) - (Math.random() * wickRange * 0.3);
                
                const volume = Math.floor(Math.random() * 15000) + 5000;
                
                data.push({
                    x: timestamp,
                    o: parseFloat(open.toFixed(symbol === 'USDJPY' ? 3 : symbol === 'BTCUSD' ? 0 : 4)),
                    h: parseFloat(high.toFixed(symbol === 'USDJPY' ? 3 : symbol === 'BTCUSD' ? 0 : 4)),
                    l: parseFloat(low.toFixed(symbol === 'USDJPY' ? 3 : symbol === 'BTCUSD' ? 0 : 4)),
                    c: parseFloat(close.toFixed(symbol === 'USDJPY' ? 3 : symbol === 'BTCUSD' ? 0 : 4))
                });
                
                volumeData.push({
                    x: timestamp,
                    y: volume
                });
                
                currentPrice = close;
            }
            
            // Update Chart.js
            if (chartInstance && chartInstance.data) {
                chartInstance.data.datasets[0].data = data;
                chartInstance.data.datasets[1].data = volumeData;
                chartInstance.data.datasets[0].label = `${symbol} Price - Simulated Data`;
                chartInstance.update('none');
            }
            
            // Update LightweightCharts
            if (lightweightChart && window.lightweightChartsActive) {
                try {
                    const lwData = data.map(item => ({
                        time: Math.floor(item.x.getTime() / 1000),
                        open: item.o,
                        high: item.h,
                        low: item.l,
                        close: item.c
                    }));
                    
                    const volumeLwData = volumeData.map((item, index) => ({
                        time: Math.floor(item.x.getTime() / 1000),
                        value: item.y,
                        color: data[index].c >= data[index].o ? 
                            'rgba(0, 208, 132, 0.5)' : 'rgba(255, 71, 87, 0.5)'
                    }));
                    
                    lightweightChart.candlestickSeries.setData(lwData);
                    lightweightChart.volumeSeries.setData(volumeLwData);
                } catch (error) {
                    console.warn('LightweightCharts update error:', error);
                }
            }
            
            // Update current price display with last data point
            const lastPrice = data[data.length - 1];
            updatePriceDisplay({
                symbol: symbol,
                price: lastPrice.c,
                change: lastPrice.c - lastPrice.o,
                change_percent: ((lastPrice.c - lastPrice.o) / lastPrice.o) * 100,
                timestamp: new Date(),
                source: 'Simulated'
            });
        }

        // Enhanced chart timeframe update
        function updateChartTimeframe(timeframe) {
            console.log(`📊 Updating chart timeframe to: ${timeframe}`);
            
            // Update Chart.js timeframe
            if (chartInstance && chartInstance.options) {
                const timeUnit = {
                    '1m': 'minute',
                    '5m': 'minute', 
                    '15m': 'minute',
                    '1h': 'hour',
                    '4h': 'hour',
                    '1d': 'day',
                    '1w': 'week'
                }[timeframe] || 'minute';
                
                chartInstance.options.scales.x.time.unit = timeUnit;
                chartInstance.update('none');
            }
            
            // Update TradingView chart if available
            if (chartInstance && chartInstance.setResolution) {
                const tvTimeframe = convertTimeframeToTradingView(timeframe);
                chartInstance.setResolution(tvTimeframe, () => {
                    console.log(`📊 TradingView timeframe updated to ${timeframe}`);
                });
            }
            
            // Regenerate data with appropriate timeframe
            if (currentSymbol === 'XAUUSD') {
                generateInitialHistoricalData();
            } else {
                generateSymulatedDataForSymbol(currentSymbol);
            }
            
            showNotification(`Timeframe changed to ${timeframe.toUpperCase()}`, 'info');
        }

        // Enhanced indicator toggle with visual feedback
        function toggleChartIndicator(indicator, enabled) {
            console.log(`📈 ${enabled ? 'Enabling' : 'Disabling'} indicator: ${indicator}`);
            
            // Map indicator names to display names
            const indicatorNames = {
                'volume': 'Volume',
                'rsi': 'RSI (Relative Strength Index)',
                'macd': 'MACD (Moving Average Convergence Divergence)',
                'bb': 'Bollinger Bands'
            };
            
            const displayName = indicatorNames[indicator] || indicator.toUpperCase();
            
            if (enabled) {
                console.log(`✅ ${displayName} indicator enabled`);
                // For Chart.js, show/hide volume dataset
                if (indicator === 'volume' && chartInstance && chartInstance.data.datasets[1]) {
                    chartInstance.data.datasets[1].hidden = false;
                    chartInstance.update('none');
                }
            } else {
                console.log(`❌ ${displayName} indicator disabled`);
                // For Chart.js, hide volume dataset
                if (indicator === 'volume' && chartInstance && chartInstance.data.datasets[1]) {
                    chartInstance.data.datasets[1].hidden = true;
                    chartInstance.update('none');
                }
            }
        }

        // Enhanced connection handling
        socket.on('connect', function() {
            console.log('🚀 Connected to GoldGPT Pro');
            const statusDots = document.querySelectorAll('.status-dot');
            statusDots.forEach(dot => {
                if (dot) dot.style.background = 'var(--success)';
            });
            
            // Request initial data on connection
            const symbols = ['XAUUSD', 'XAGUSD', 'EURUSD', 'GBPUSD', 'USDJPY', 'BTCUSD'];
            socket.emit('get_prices', { symbols: symbols });
            
            showNotification('Connected to GoldGPT Pro server', 'success');
        });
        
        socket.on('disconnect', function() {
            console.log('❌ Disconnected from server');
            const statusDots = document.querySelectorAll('.status-dot');
            statusDots.forEach(dot => {
                if (dot) dot.style.background = 'var(--danger)';
            });
            
            showNotification('Disconnected from server', 'warning');
        });
        
        // Enhanced price update handling
        socket.on('price_update', function(data) {
            updatePriceDisplay(data);
            updateOrderBook(data);
            
            // Update chart if it's the current symbol
            if (data.symbol === currentSymbol) {
                goldPriceFetcher.processPriceUpdate(data);
            }
        });
        
        socket.on('trade_executed', function(data) {
            showNotification(`Trade executed: ${data.side.toUpperCase()} ${data.amount} lots`, 'success');
            updatePositions();
        });

        // Enhanced macro data update handler
        socket.on('macro_update', function(data) {
            console.log('📊 Macro data update received:', data);
            macroData = data;
            updateMacroDisplay();
        });

        // Enhanced news update handler
        socket.on('news_update', function(data) {
            console.log('📰 News update received:', data);
            newsData = data;
            updateNewsDisplay();
        });
            
        // Unified Chart Control System
        window.chartManager = {
                currentTimeframe: '1h',
                activeIndicators: new Set(['rsi']),
                chart: null,
                candlestickSeries: null,
                volumeSeries: null,
                indicators: {},
                
                init() {
                    this.initChart();
                    this.setupEventListeners();
                },
                
                initChart() {
                    const chartContainer = document.getElementById('tradingview-chart');
                    if (!chartContainer) return;
                    
                    // Clear any existing chart
                    chartContainer.innerHTML = '';
                    
                    // Create LightweightChart
                    this.chart = LightweightCharts.createChart(chartContainer, {
                        width: chartContainer.clientWidth,
                        height: 500,
                        layout: {
                            background: { type: 'solid', color: '#1a1a1a' },
                            textColor: '#d1d5db',
                        },
                        grid: {
                            vertLines: { color: '#2a2a2a' },
                            horzLines: { color: '#2a2a2a' },
                        },
                        crosshair: {
                            mode: LightweightCharts.CrosshairMode.Normal,
                        },
                        rightPriceScale: {
                            borderColor: '#2a2a2a',
                        },
                        timeScale: {
                            borderColor: '#2a2a2a',
                            timeVisible: true,
                            secondsVisible: false,
                        },
                    });
                    
                    // Add candlestick series
                    this.candlestickSeries = this.chart.addCandlestickSeries({
                        upColor: '#00d084',
                        downColor: '#ff4757',
                        borderDownColor: '#ff4757',
                        borderUpColor: '#00d084',
                        wickDownColor: '#ff4757',
                        wickUpColor: '#00d084',
                    });
                    
                    // Add volume series
                    this.volumeSeries = this.chart.addHistogramSeries({
                        color: '#26a69a',
                        priceFormat: {
                            type: 'volume',
                        },
                        priceScaleId: '',
                        scaleMargins: {
                            top: 0.8,
                            bottom: 0,
                        },
                    });
                    
                    // Load initial data
                    this.loadChartData();
                    
                    // Handle resize
                    window.addEventListener('resize', () => {
                        this.chart.applyOptions({
                            width: chartContainer.clientWidth,
                        });
                    });
                },
                
                setupEventListeners() {
                    // Timeframe buttons
                    document.querySelectorAll('.timeframe-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const timeframe = e.target.dataset.timeframe;
                            this.changeTimeframe(timeframe);
                        });
                    });
                    
                    // Indicator buttons
                    document.querySelectorAll('.indicator-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const indicator = e.target.dataset.indicator;
                            this.toggleIndicator(indicator);
                        });
                    });
                },
                
                changeTimeframe(timeframe) {
                    console.log(`📊 Changing timeframe to ${timeframe}`);
                    
                    // Update UI
                    document.querySelectorAll('.timeframe-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelector(`[data-timeframe="${timeframe}"]`)?.classList.add('active');
                    
                    this.currentTimeframe = timeframe;
                    this.loadChartData();
                    
                    // Show visual feedback
                    this.showNotification(`📊 Switched to ${timeframe.toUpperCase()} timeframe`, 'success');
                },
                
                toggleIndicator(indicator) {
                    console.log(`📈 Toggling ${indicator} indicator`);
                    
                    const btn = document.querySelector(`[data-indicator="${indicator}"]`);
                    if (!btn) return;
                    
                    if (this.activeIndicators.has(indicator)) {
                        // Remove indicator
                        this.activeIndicators.delete(indicator);
                        btn.classList.remove('active');
                        this.removeIndicator(indicator);
                        this.showNotification(`📉 ${indicator.toUpperCase()} indicator hidden`, 'info');
                    } else {
                        // Add indicator
                        this.activeIndicators.add(indicator);
                        btn.classList.add('active');
                        this.addIndicator(indicator);
                        this.showNotification(`📈 ${indicator.toUpperCase()} indicator shown`, 'success');
                    }
                },
                
                addIndicator(indicator) {
                    switch(indicator) {
                        case 'volume':
                            if (this.volumeSeries) {
                                this.volumeSeries.applyOptions({ visible: true });
                            }
                            break;
                        case 'rsi':
                            this.addRSI();
                            break;
                        case 'macd':
                            this.addMACD();
                            break;
                        case 'bb':
                            this.addBollingerBands();
                            break;
                    }
                },
                
                removeIndicator(indicator) {
                    switch(indicator) {
                        case 'volume':
                            if (this.volumeSeries) {
                                this.volumeSeries.applyOptions({ visible: false });
                            }
                            break;
                        case 'rsi':
                            if (this.indicators.rsi) {
                                this.chart.removeSeries(this.indicators.rsi);
                                delete this.indicators.rsi;
                            }
                            break;
                        case 'macd':
                            if (this.indicators.macd) {
                                this.chart.removeSeries(this.indicators.macd);
                                delete this.indicators.macd;
                            }
                            break;
                        case 'bb':
                            if (this.indicators.bb) {
                                this.indicators.bb.forEach(series => this.chart.removeSeries(series));
                                delete this.indicators.bb;
                            }
                            break;
                    }
                },
                
                addRSI() {
                    if (this.indicators.rsi) return;
                    
                    this.indicators.rsi = this.chart.addLineSeries({
                        color: '#2196F3',
                        lineWidth: 2,
                        priceScaleId: 'rsi',
                    });
                    
                    this.chart.priceScale('rsi').applyOptions({
                        scaleMargins: {
                            top: 0.8,
                            bottom: 0,
                        },
                    });
                },
                
                addMACD() {
                    if (this.indicators.macd) return;
                    
                    this.indicators.macd = this.chart.addLineSeries({
                        color: '#FF9800',
                        lineWidth: 2,
                        priceScaleId: 'macd',
                    });
                    
                    this.chart.priceScale('macd').applyOptions({
                        scaleMargins: {
                            top: 0.85,
                            bottom: 0,
                        },
                    });
                },
                
                addBollingerBands() {
                    if (this.indicators.bb) return;
                    
                    this.indicators.bb = [
                        this.chart.addLineSeries({
                            color: '#9C27B0',
                            lineWidth: 1,
                            lineStyle: LightweightCharts.LineStyle.Dashed,
                        }),
                        this.chart.addLineSeries({
                            color: '#9C27B0',
                            lineWidth: 1,
                            lineStyle: LightweightCharts.LineStyle.Dashed,
                        })
                    ];
                },
                
                async loadChartData() {
                    if (!this.candlestickSeries) return;
                    
                    try {
                        console.log(`📊 Loading ${this.currentTimeframe} chart data...`);
                        
                        // Fetch chart data from backend
                        const response = await fetch(`/api/chart/data/XAUUSD?timeframe=${this.currentTimeframe}&limit=200`);
                        const result = await response.json();
                        
                        if (result.success && result.data) {
                            const ohlcData = result.data;
                            const volumeData = ohlcData.map(d => ({
                                time: d.time,
                                value: d.volume,
                                color: d.close > d.open ? '#00d084' : '#ff4757'
                            }));
                            
                            // Update chart data
                            this.candlestickSeries.setData(ohlcData);
                            if (this.volumeSeries && this.activeIndicators.has('volume')) {
                                this.volumeSeries.setData(volumeData);
                            }
                            
                            // Update indicators with real calculations
                            this.updateIndicators(ohlcData);
                            
                            console.log(`✅ Loaded ${ohlcData.length} ${this.currentTimeframe} candles`);
                        } else {
                            throw new Error(result.error || 'Failed to load chart data');
                        }
                        
                    } catch (error) {
                        console.error('Error loading chart data:', error);
                        this.showNotification('❌ Error loading chart data', 'error');
                        
                        // Fallback to generated data
                        await this.loadFallbackData();
                    }
                },
                
                async loadFallbackData() {
                    console.log('📊 Loading fallback chart data...');
                    
                    // Get current Gold price for baseline
                    try {
                        const response = await fetch('/api/gold/price');
                        const goldData = await response.json();
                        const currentPrice = goldData.price || 3354.90;
                        
                        const data = this.generateOHLCData(currentPrice, this.getTimeframeMinutes());
                        const volumeData = this.generateVolumeData(data.length);
                        
                        this.candlestickSeries.setData(data);
                        if (this.volumeSeries && this.activeIndicators.has('volume')) {
                            this.volumeSeries.setData(volumeData);
                        }
                        
                        this.updateIndicators(data);
                        
                    } catch (error) {
                        console.error('Error loading fallback data:', error);
                    }
                },
                
                generateOHLCData(basePrice, intervalMinutes) {
                    const data = [];
                    const now = Math.floor(Date.now() / 1000);
                    const candles = 200;
                    
                    let price = basePrice * 0.95; // Start 5% below current
                    
                    for (let i = candles; i >= 0; i--) {
                        const time = now - (i * intervalMinutes * 60);
                        const volatility = basePrice * 0.002; // 0.2% volatility
                        
                        const open = price;
                        const change = (Math.random() - 0.5) * volatility * 2;
                        const high = Math.max(open, open + change) + Math.random() * volatility;
                        const low = Math.min(open, open + change) - Math.random() * volatility;
                        const close = open + change;
                        
                        data.push({
                            time: time,
                            open: parseFloat(open.toFixed(2)),
                            high: parseFloat(high.toFixed(2)),
                            low: parseFloat(low.toFixed(2)),
                            close: parseFloat(close.toFixed(2))
                        });
                        
                        price = close;
                    }
                    
                    return data;
                },
                
                generateVolumeData(length) {
                    const data = [];
                    const now = Math.floor(Date.now() / 1000);
                    const intervalMinutes = this.getTimeframeMinutes();
                    
                    for (let i = length; i >= 0; i--) {
                        const time = now - (i * intervalMinutes * 60);
                        const volume = Math.floor(Math.random() * 1000000) + 100000;
                        
                        data.push({
                            time: time,
                            value: volume,
                            color: Math.random() > 0.5 ? '#00d084' : '#ff4757'
                        });
                    }
                    
                    return data;
                },
                
                updateIndicators(ohlcData) {
                    // Calculate and update RSI
                    if (this.activeIndicators.has('rsi') && this.indicators.rsi) {
                        const rsiData = this.calculateRSI(ohlcData);
                        this.indicators.rsi.setData(rsiData);
                    }
                    
                    // Calculate and update MACD
                    if (this.activeIndicators.has('macd') && this.indicators.macd) {
                        const macdData = this.calculateMACD(ohlcData);
                        this.indicators.macd.setData(macdData);
                    }
                    
                    // Calculate and update Bollinger Bands
                    if (this.activeIndicators.has('bb') && this.indicators.bb) {
                        const bbData = this.calculateBollingerBands(ohlcData);
                        this.indicators.bb[0].setData(bbData.upper);
                        this.indicators.bb[1].setData(bbData.lower);
                    }
                },
                
                calculateRSI(data, period = 14) {
                    const rsi = [];
                    if (data.length < period + 1) return rsi;
                    
                    for (let i = period; i < data.length; i++) {
                        let gains = 0;
                        let losses = 0;
                        
                        for (let j = i - period + 1; j <= i; j++) {
                            const change = data[j].close - data[j-1].close;
                            if (change > 0) gains += change;
                            else losses -= change;
                        }
                        
                        const avgGain = gains / period;
                        const avgLoss = losses / period;
                        const rs = avgGain / avgLoss;
                        const rsiValue = 100 - (100 / (1 + rs));
                        
                        rsi.push({
                            time: data[i].time,
                            value: parseFloat(rsiValue.toFixed(2))
                        });
                    }
                    
                    return rsi;
                },
                
                calculateMACD(data, fastPeriod = 12, slowPeriod = 26, signalPeriod = 9) {
                    const macd = [];
                    if (data.length < slowPeriod) return macd;
                    
                    // Simplified MACD calculation
                    for (let i = slowPeriod; i < data.length; i++) {
                        const fastEMA = this.calculateEMA(data.slice(i - fastPeriod + 1, i + 1), fastPeriod);
                        const slowEMA = this.calculateEMA(data.slice(i - slowPeriod + 1, i + 1), slowPeriod);
                        const macdValue = fastEMA - slowEMA;
                        
                        macd.push({
                            time: data[i].time,
                            value: parseFloat(macdValue.toFixed(4))
                        });
                    }
                    
                    return macd;
                },
                
                calculateEMA(data, period) {
                    const multiplier = 2 / (period + 1);
                    let ema = data[0].close;
                    
                    for (let i = 1; i < data.length; i++) {
                        ema = (data[i].close * multiplier) + (ema * (1 - multiplier));
                    }
                    
                    return ema;
                },
                
                calculateBollingerBands(data, period = 20, stdDev = 2) {
                    const upper = [];
                    const lower = [];
                    
                    if (data.length < period) return { upper, lower };
                    
                    for (let i = period - 1; i < data.length; i++) {
                        const slice = data.slice(i - period + 1, i + 1);
                        const sma = slice.reduce((sum, d) => sum + d.close, 0) / period;
                        const variance = slice.reduce((sum, d) => sum + Math.pow(d.close - sma, 2), 0) / period;
                        const standardDev = Math.sqrt(variance);
                        
                        upper.push({
                            time: data[i].time,
                            value: parseFloat((sma + (standardDev * stdDev)).toFixed(2))
                        });
                        
                        lower.push({
                            time: data[i].time,
                            value: parseFloat((sma - (standardDev * stdDev)).toFixed(2))
                        });
                    }
                    
                    return { upper, lower };
                },
                
                getTimeframeMinutes() {
                    const timeframeMap = {
                        '1m': 1,
                        '5m': 5,
                        '15m': 15,
                        '1h': 60,
                        '4h': 240,
                        '1d': 1440,
                        '1w': 10080
                    };
                    return timeframeMap[this.currentTimeframe] || 60;
                },
                
                showNotification(message, type = 'info') {
                    // Create notification element
                    const notification = document.createElement('div');
                    notification.className = `notification notification-${type}`;
                    notification.textContent = message;
                    notification.style.cssText = `
                        position: fixed;
                        top: 80px;
                        right: 20px;
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        padding: 12px 20px;
                        border-radius: 8px;
                        border-left: 4px solid var(--accent-primary);
                        box-shadow: var(--shadow-lg);
                        z-index: 1000;
                        animation: slideInRight 0.3s ease;
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Remove after 3 seconds
                    setTimeout(() => {
                        notification.style.animation = 'slideOutRight 0.3s ease';
                        setTimeout(() => notification.remove(), 300);
                    }, 3000);
                }
            };
            
            // Check if LightweightCharts is loaded
            console.log('🔍 LightweightCharts available:', typeof LightweightCharts !== 'undefined');
            console.log('🔍 Chart container exists:', !!document.getElementById('tradingview-chart'));
            
            // Initialize chart manager
            try {
                window.chartManager.init();
                console.log('✅ Chart Manager initialized successfully');
            } catch (error) {
                console.error('❌ Chart Manager initialization failed:', error);
                
                // Fallback: Add basic button handlers
                console.log('🔄 Adding fallback button handlers...');
                
                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        const timeframe = this.dataset.timeframe;
                        console.log(`📊 Timeframe changed to ${timeframe}`);
                        
                        // Show notification
                        showSimpleNotification(`📊 Switched to ${timeframe.toUpperCase()} timeframe`);
                    });
                });
                
                document.querySelectorAll('.indicator-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        this.classList.toggle('active');
                        const indicator = this.dataset.indicator;
                        const isActive = this.classList.contains('active');
                        console.log(`📈 ${indicator} indicator ${isActive ? 'enabled' : 'disabled'}`);
                        
                        // Show notification
                        showSimpleNotification(`📈 ${indicator.toUpperCase()} indicator ${isActive ? 'enabled' : 'disabled'}`);
                    });
                });
                
                console.log('✅ Fallback button handlers added');
            }
            
            // Helper function for simple notifications
            function showSimpleNotification(message) {
                const notification = document.createElement('div');
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed; top: 80px; right: 20px; z-index: 1000;
                    background: #2a2a2a; color: white; padding: 12px 20px;
                    border-radius: 8px; border-left: 4px solid #00d084;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: slideInRight 0.3s ease;
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
            
            // Initialize AI Analysis Center
            if (typeof AdvancedAIAnalysisCenter !== 'undefined') {
                console.log('🤖 Initializing AI Analysis Center...');
                window.aiAnalysisCenter = new AdvancedAIAnalysisCenter(socket);
                window.aiAnalysisCenter.initialize();
                console.log('✅ AI Analysis Center Initialized');
            } else {
                console.warn('⚠️ AI Analysis Center class not found - loading fallback');
            }
            
            // Start real-time data updates
            const symbols = ['XAUUSD', 'XAGUSD', 'EURUSD', 'BTCUSD'];
            symbols.forEach(symbol => {
                socket.emit('subscribe_symbol', { symbol: symbol });
            });
            
            // Periodic data refresh
            setInterval(function() {
                socket.emit('get_prices', { symbols: symbols });
                
                // Request AI analysis update
                if (window.aiAnalysisCenter) {
                    socket.emit('get_ai_analysis', { symbol: currentSymbol });
                }
            }, 5000);
            
            // Load initial data
            updatePositions();
            
            console.log('✅ GoldGPT Pro Dashboard Initialized');
        }); // End main initialization
        
        // Helper functions for symbol conversion
        function getTradingViewSymbol(symbol) {
            const symbolMap = {
                'XAUUSD': 'OANDA:XAUUSD',
                'XAGUSD': 'OANDA:XAGUSD', 
                'EURUSD': 'OANDA:EURUSD',
                'GBPUSD': 'OANDA:GBPUSD',
                'USDJPY': 'OANDA:USDJPY',
                'BTCUSD': 'COINBASE:BTCUSD',
                'SPY': 'AMEX:SPY',
                'QQQ': 'NASDAQ:QQQ'
            };
            return symbolMap[symbol] || `OANDA:${symbol}`;
        }
        
        function getSymbolDisplayName(symbol) {
            const nameMap = {
                'XAUUSD': 'XAU/USD - Gold Spot',
                'XAGUSD': 'XAG/USD - Silver Spot',
                'EURUSD': 'EUR/USD - Euro Dollar',
                'GBPUSD': 'GBP/USD - British Pound',
                'USDJPY': 'USD/JPY - Dollar Yen',
                'BTCUSD': 'BTC/USD - Bitcoin',
                'SPY': 'SPY - S&P 500 ETF',
                'QQQ': 'QQQ - NASDAQ 100 ETF'
            };
            return nameMap[symbol] || symbol;
        }
        
        function getSymbolBadge(symbol) {
            const badgeMap = {
                'XAUUSD': 'GOLD',
                'XAGUSD': 'SILVER',
                'EURUSD': 'EUR',
                'GBPUSD': 'GBP',
                'USDJPY': 'JPY',
                'BTCUSD': 'BTC',
                'SPY': 'SPY',
                'QQQ': 'QQQ'
            };
            return badgeMap[symbol] || symbol;
        }
        
        function convertTimeframeToTradingView(timeframe) {
            const timeframeMap = {
                '1m': '1',
                '5m': '5',
                '15m': '15',
                '1h': '60',
                '4h': '240',
                '1d': 'D',
                '1w': 'W'
            };
            return timeframeMap[timeframe] || '60';
        }
        
        // AI Analysis update handler
        socket.on('ai_analysis_update', function(data) {
            console.log('📊 AI Analysis Update:', data);
            if (window.aiAnalysisCenter && typeof window.aiAnalysisCenter.handleUpdate === 'function') {
                window.aiAnalysisCenter.handleUpdate(data);
            }
        });
    </script>
    
    <!-- Load external JavaScript - RESTORED TO WORKING VERSION -->
    <script src="{{ url_for('static', filename='js/chart-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ai-analysis-center.js') }}"></script>
    <script src="{{ url_for('static', filename='js/advanced.js') }}"></script>
</body>
</html>
